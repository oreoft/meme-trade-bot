{% extends "base.html" %}

{% block title %}监控管理 - 币价监控系统{% endblock %}

{% block content %}
<div id="app">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-0">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        币价监控系统
                    </h1>
                    <p class="text-muted mb-0">管理和监控您的代币价格阈值</p>
                </div>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-plus me-2"></i>添加监控
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" @click="openAddModal('normal')">
                            <i class="fas fa-eye me-2"></i>普通监控（买入/卖出）
                        </a></li>
                        <li><a class="dropdown-item" href="#" @click="openAddModal('swing')">
                            <i class="fas fa-exchange-alt me-2"></i>波段监控
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="monitorRecords.length + swingRecords.length">0</h3>
                            <small>总监控数</small>
                        </div>
                        <i class="fas fa-list fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="runningCount">0</h3>
                            <small>运行中</small>
                        </div>
                        <i class="fas fa-play fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="stoppedCount">0</h3>
                            <small>已停止</small>
                        </div>
                        <i class="fas fa-stop fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="errorCount">0</h3>
                            <small>错误状态</small>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 监控列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>出售监听列表
                    </h5>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载中...</p>
                    </div>
                    <div v-else-if="sellRecords.length === 0" class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无出售监听记录</h5>
                    </div>
                    <div v-else class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="min-width: 120px;">名称</th>
                                    <th style="min-width: 100px;">代币地址</th>
                                    <th style="min-width: 70px;">阈值</th>
                                    <th style="min-width: 80px;">当前市值</th>
                                    <th style="min-width: 90px;">距离阈值</th>
                                    <th style="min-width: 60px;">出售%</th>
                                    <th style="min-width: 60px;">执行</th>
                                    <th style="min-width: 70px;">最低持仓</th>
                                    <th style="min-width: 50px;">间隔</th>
                                    <th style="min-width: 60px;">状态</th>
                                    <th style="min-width: 100px;">最后检查</th>
                                    <th style="min-width: 140px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="record in sellRecords" :key="record.id">
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-warning mb-1" style="font-size: 0.65rem;">出售</span>
                                            <strong class="small" v-text="record.name"></strong>
                                        </div>
                                    </td>
                                    <td>
                                        <a :href="'https://dexscreener.com/solana/' + record.token_address" target="_blank" class="text-decoration-none" :title="record.token_address">
                                            <code class="small text-primary">
                                              <div v-text="record.token_address.substring(0, 4) + '...' + record.token_address.substring(record.token_address.length - 4)"></div>
                                              <small v-if="record.token_symbol" class="text-muted">(<span v-text="record.token_symbol"></span>)</small>
                                            </code>
                                        </a>
                                    </td>
                                    <td><strong class="small" v-text="'$' + formatShortNumber(record.threshold)"></strong></td>
                                    <td>
                                        <span v-if="record.last_market_cap" class="fw-bold small" v-text="'$' + formatShortNumber(record.last_market_cap)"></span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td>
                                        <span v-if="record.last_market_cap && record.threshold" v-html="getThresholdDiffHtml(record)"></span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td><span class="badge bg-info" style="font-size: 0.7rem;" v-text="(record.sell_percentage * 100).toFixed(1) + '%'" /></td>
                                    <td><span class="badge" :class="record.execution_mode === 'single' ? 'bg-warning' : 'bg-success'" style="font-size: 0.7rem;" v-text="record.execution_mode === 'single' ? '单次' : '多次'"></span></td>
                                    <td>
                                        <span v-if="record.execution_mode === 'multiple'" class="small" v-text="'$' + formatShortNumber(record.minimum_hold_value)"></span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td><span class="small" v-text="record.check_interval + 's'"></span></td>
                                    <td><span class="badge" :class="getStatusClass(record.status)" style="font-size: 0.7rem;"><i class="fas" :class="getStatusIcon(record.status)"></i><span v-text="getStatusText(record.status)"></span></span></td>
                                    <td><small v-if="record.last_check_at" class="text-muted" v-text="formatTime(record.last_check_at)"></small><span v-else class="text-muted small">--</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm" style="gap: 4px;">
                                            <button v-if="record.status === 'stopped'" class="btn btn-outline-success btn-sm" @click="startSwingMonitor(record.id)" :disabled="swingOperationLoading[record.id]" title="启动波段监控"><i class="fas fa-play"></i></button>
                                            <button v-if="record.status === 'monitoring'" class="btn btn-outline-danger btn-sm" @click="stopSwingMonitor(record.id)" :disabled="swingOperationLoading[record.id]" title="停止波段监控"><i class="fas fa-stop"></i></button>
                                            <button class="btn btn-outline-primary btn-sm" @click="editSwingRecord(record)" :disabled="record.status === 'monitoring'" title="编辑"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-outline-info btn-sm" @click="viewLogs('normal', record.id)" title="查看日志"><i class="fas fa-history"></i></button>
                                            <button class="btn btn-outline-danger btn-sm" @click="deleteSwingRecord(record.id)" :disabled="record.status === 'monitoring'" title="删除"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>波段监控列表
                    </h5>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载中...</p>
                    </div>
                    <div v-else-if="swingRecords.length === 0" class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无波段监控记录</h5>
                    </div>
                    <div v-else class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="min-width: 120px;">名称</th>
                                    <th style="min-width: 100px;">监听代币</th>
                                    <th style="min-width: 100px;">交易代币</th>
                                    <th style="min-width: 60px;">类型</th>
                                    <th style="min-width: 80px;">当前值</th>
                                    <th style="min-width: 80px;">买入阈值</th>
                                    <th style="min-width: 80px;">卖出阈值</th>
                                    <th style="min-width: 60px;">买入%</th>
                                    <th style="min-width: 60px;">卖出%</th>
                                    <th style="min-width: 70px;">全仓阈值</th>
                                    <th style="min-width: 50px;">间隔</th>
                                    <th style="min-width: 60px;">状态</th>
                                    <th style="min-width: 100px;">最后检查</th>
                                    <th style="min-width: 120px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="record in swingRecords" :key="record.id">
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-info mb-1" style="font-size: 0.65rem;">波段</span>
                                            <strong class="small" v-text="record.name"></strong>
                                        </div>
                                    </td>
                                    <td>
                                        <a :href="'https://dexscreener.com/solana/' + record.watch_token_address" target="_blank" class="text-decoration-none" :title="record.watch_token_address">
                                            <code class="small text-primary">
                                              <div v-text="record.watch_token_address.substring(0, 4) + '...' + record.watch_token_address.substring(record.watch_token_address.length - 4)"></div>
                                              <small v-if="record.watch_token_symbol" class="text-muted">(<span v-text="record.watch_token_symbol"></span>)</small>
                                            </code>
                                        </a>
                                    </td>
                                    <td>
                                        <a :href="'https://dexscreener.com/solana/' + record.trade_token_address" target="_blank" class="text-decoration-none" :title="record.trade_token_address">
                                            <code class="small text-success">
                                              <div v-text="record.trade_token_address.substring(0, 4) + '...' + record.trade_token_address.substring(record.trade_token_address.length - 4)"></div>
                                              <small v-if="record.trade_token_symbol" class="text-muted">(<span v-text="record.trade_token_symbol"></span>)</small>
                                            </code>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge" :class="record.price_type === 'price' ? 'bg-warning' : 'bg-info'" v-text="record.price_type === 'price' ? '单价' : '市值'"></span>
                                    </td>
                                    <td>
                                        <span v-if="record.price_type === 'price' && record.last_watch_price" class="fw-bold small" v-text="'$' + record.last_watch_price.toFixed(2)"></span>
                                        <span v-else-if="record.price_type === 'market_cap' && record.last_watch_market_cap" class="fw-bold small" v-text="'$' + formatShortNumber(record.last_watch_market_cap)"></span>
                                        <span v-else class="text-muted">--</span>
                                    </td>
                                    <td><strong class="text-success small" v-text="'$' + formatShortNumber(record.buy_threshold)"></strong></td>
                                    <td><strong class="text-danger small" v-text="'$' + formatShortNumber(record.sell_threshold)"></strong></td>
                                    <td><span class="badge bg-success" style="font-size: 0.7rem;" v-text="(record.buy_percentage * 100).toFixed(1) + '%'" /></td>
                                    <td><span class="badge bg-danger" style="font-size: 0.7rem;" v-text="(record.sell_percentage * 100).toFixed(1) + '%'" /></td>
                                    <td><span class="small" v-text="'$' + formatShortNumber(record.all_in_threshold)"></span></td>
                                    <td><span class="small" v-text="record.check_interval + 's'"></span></td>
                                    <td><span class="badge" :class="getStatusClass(record.status)" style="font-size: 0.7rem;"><i class="fas" :class="getStatusIcon(record.status)"></i><span v-text="getStatusText(record.status)"></span></span></td>
                                    <td><small v-if="record.last_check_at" class="text-muted" v-text="formatTime(record.last_check_at)"></small><span v-else class="text-muted">--</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm" style="gap: 4px;">
                                            <button v-if="record.status === 'stopped'" class="btn btn-outline-success btn-sm" @click="startSwingMonitor(record.id)" :disabled="swingOperationLoading[record.id]" title="启动波段监控"><i class="fas fa-play"></i></button>
                                            <button v-if="record.status === 'monitoring'" class="btn btn-outline-danger btn-sm" @click="stopSwingMonitor(record.id)" :disabled="swingOperationLoading[record.id]" title="停止波段监控"><i class="fas fa-stop"></i></button>
                                            <button class="btn btn-outline-primary btn-sm" @click="editSwingRecord(record)" :disabled="record.status === 'monitoring'" title="编辑"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-outline-info btn-sm" @click="viewLogs('swing', record.id)" title="查看日志"><i class="fas fa-history"></i></button>
                                            <button class="btn btn-outline-danger btn-sm" @click="deleteSwingRecord(record.id)" :disabled="record.status === 'monitoring'" title="删除"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-up me-2"></i>购买监听列表
                    </h5>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载中...</p>
                    </div>
                    <div v-else-if="buyRecords.length === 0" class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无购买监听记录</h5>
                    </div>
                    <div v-else class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="min-width: 120px;">名称</th>
                                    <th style="min-width: 100px;">代币地址</th>
                                    <th style="min-width: 70px;">阈值</th>
                                    <th style="min-width: 80px;">当前市值</th>
                                    <th style="min-width: 90px;">距离阈值</th>
                                    <th style="min-width: 60px;">购买%</th>
                                    <th style="min-width: 60px;">执行</th>
                                    <th style="min-width: 100px;">累计购买</th>
                                    <th style="min-width: 50px;">间隔</th>
                                    <th style="min-width: 60px;">状态</th>
                                    <th style="min-width: 100px;">最后检查</th>
                                    <th style="min-width: 140px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="record in buyRecords" :key="record.id">
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-primary mb-1" style="font-size: 0.65rem;">买入</span>
                                            <strong class="small" v-text="record.name"></strong>
                                        </div>
                                    </td>
                                    <td>
                                        <a :href="'https://dexscreener.com/solana/' + record.token_address" target="_blank" class="text-decoration-none" :title="record.token_address">
                                            <code class="small text-primary">
                                              <div v-text="record.token_address.substring(0, 4) + '...' + record.token_address.substring(record.token_address.length - 4)"></div>
                                              <small v-if="record.token_symbol" class="text-muted">(<span v-text="record.token_symbol"></span>)</small>
                                            </code>
                                        </a>
                                    </td>
                                    <td><strong class="small" v-text="'$' + formatShortNumber(record.threshold)"></strong></td>
                                    <td>
                                        <span v-if="record.last_market_cap" class="fw-bold small" v-text="'$' + formatShortNumber(record.last_market_cap)"></span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td>
                                        <span v-if="record.last_market_cap && record.threshold && record.last_market_cap > record.threshold"
                                              class="fw-bold text-success small"
                                              v-text="'还需跌 $' + formatShortNumber(record.last_market_cap - record.threshold)"></span>
                                        <span v-else-if="record.last_market_cap && record.threshold"
                                              class="fw-bold text-danger small"
                                              v-text="'已低于阈值'"></span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td><span class="badge bg-info" style="font-size: 0.7rem;" v-text="(record.sell_percentage * 100).toFixed(1) + '%'" /></td>
                                    <td><span class="badge" :class="record.execution_mode === 'single' ? 'bg-warning' : 'bg-success'" style="font-size: 0.7rem;" v-text="record.execution_mode === 'single' ? '单次' : '多次'"/></td>
                                    <td>
                                        <span v-if="record.max_buy_amount && record.max_buy_amount > 0" class="small">
                                            <div v-text="(typeof record.accumulated_buy_usd !== 'undefined' ? ('$' + formatShortNumber(record.accumulated_buy_usd)) : (record._accumulated_buy_usd ? ('$' + formatShortNumber(record._accumulated_buy_usd)) : '$0.00'))"></div>
                                            <small class="text-muted">/ $<span v-text="formatShortNumber(record.max_buy_amount)"></span></small>
                                        </span>
                                        <span v-else class="text-muted small">--</span>
                                    </td>
                                    <td><span class="small" v-text="record.check_interval + 's'"></span></td>
                                    <td><span class="badge" :class="getStatusClass(record.status)" style="font-size: 0.7rem;"><i class="fas" :class="getStatusIcon(record.status)"></i><span v-text="getStatusText(record.status)"></span></span></td>
                                    <td><small v-if="record.last_check_at" class="text-muted" v-text="formatTime(record.last_check_at)"></small><span v-else class="text-muted small">--</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm" style="gap: 4px;">
                                            <button v-if="record.status === 'stopped'" class="btn btn-outline-success btn-sm" @click="startMonitor(record.id)" :disabled="operationLoading[record.id]" title="启动监控"><i class="fas fa-play"></i></button>
                                            <button v-if="record.status === 'monitoring'" class="btn btn-outline-danger btn-sm" @click="stopMonitor(record.id)" :disabled="operationLoading[record.id]" title="停止监控"><i class="fas fa-stop"></i></button>
                                            <button class="btn btn-outline-primary btn-sm" @click="editRecord(record)" :disabled="record.status === 'monitoring'" title="编辑"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-outline-info btn-sm" @click="viewLogs('normal', record.id)" title="查看日志"><i class="fas fa-history"></i></button>
                                            <button class="btn btn-outline-danger btn-sm" @click="deleteRecord(record.id)" :disabled="record.status === 'monitoring'" title="删除"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑监控记录模态框 -->
    <div class="modal fade" :class="{ show: showAddModal || showEditModal }"
         :style="{ display: showAddModal || showEditModal ? 'block' : 'none' }"
         @click="closeModal">
        <div class="modal-dialog modal-lg" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        <span v-if="showEditModal">编辑监控记录</span>
                        <span v-else>添加监控记录</span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeModal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveRecord">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">监控名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="recordForm.name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">检查间隔(秒) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="recordForm.check_interval" min="1" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">监控类型 <span class="text-danger">*</span></label>
                            <select class="form-select" v-model="recordForm.type" required>
                                <option value="sell">出售监听（Token变SOL）</option>
                                <option value="buy">购买监听（SOL变Token）</option>
                            </select>
                            <div class="form-text">选择监听类型后，表单内容会动态变化</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">选择钱包私钥 <span class="text-danger">*</span></label>
                            <select class="form-select" v-model="recordForm.private_key_id" required>
                                <option value="">请选择钱包私钥</option>
                                <option v-for="key in privateKeys" :key="key.id" :value="key.id" v-text="key.nickname + ' (' + key.public_key.substring(0,8) + '...' + key.public_key.substring(key.public_key.length-8) + ')'">
                                </option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                如果列表为空，请先到
                                <a href="/keys" target="_blank" class="text-decoration-none">私钥管理</a>
                                页面添加私钥
                            </div>
                        </div>
                        <div class="mb-3 position-relative">
                            <label class="form-label">代币地址 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="recordForm.token_address"
                                   :class="{ 'is-invalid': tokenAddressError }"
                                   @input="onTokenAddressInput" @focus="onTokenAddressInput" @blur="onTokenAddressBlur"
                                   required placeholder="请输入代币地址或选择" autocomplete="off">
                            <div v-if="showTokenDropdown && (filteredTokenList.length > 0 || tokensLoading)"
                                 class="dropdown-menu show w-100 mt-1"
                                 style="max-height:260px;overflow:auto;z-index:1050;">
                                <div v-if="tokensLoading" class="dropdown-item text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                    <span class="text-muted">加载代币列表中...</span>
                                </div>
                                <div v-else-if="filteredTokenList.length === 0" class="dropdown-item text-center py-3 text-muted">
                                    <i class="fas fa-search me-2"></i>
                                    <span>未找到匹配的代币</span>
                                </div>
                                <div v-else v-for="token in filteredTokenList" :key="token.address"
                                     class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer;"
                                     @mousedown.prevent="selectToken(token)">
                                    <img v-if="token.logo_uri" :src="token.logo_uri" style="width:20px;height:20px;"
                                         class="rounded-circle">
                                    <span class="fw-bold" v-text="token.name"></span>
                                    <span class="badge bg-secondary ms-2" v-text="token.symbol"></span>
                                    <span class="text-muted ms-auto small"
                                          v-text="token.address.substring(0,6)+'...'+token.address.substring(token.address.length-6)"></span>
                                </div>
                            </div>
                            <div v-if="selectedTokenInfo" class="form-text mt-2">
                                <div class="d-flex align-items-center">
                                    <img v-if="selectedTokenInfo.logo_uri" :src="selectedTokenInfo.logo_uri"
                                         alt="token logo" class="me-2 rounded-circle"
                                         style="width: 24px; height: 24px;"
                                         @error="$event.target.style.display='none'">
                                    <span class="fw-bold me-2" v-text="selectedTokenInfo.name || '未知'"></span>
                                    <span class="badge bg-secondary" v-text="selectedTokenInfo.symbol || 'N/A'"></span>
                                </div>
                            </div>
                            <div v-if="tokenAddressError" class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <span v-text="tokenAddressError"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">市值阈值(USD) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="recordForm.threshold" step="0.01" min="0" required @input="onThresholdInput">
                                    <div class="form-text" v-if="recordForm.type === 'sell'">市值高于此值时出售</div>
                                    <div class="form-text" v-else>市值低于此值时买入</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" v-if="recordForm.type === 'sell'">出售比例 <span class="text-danger">*</span></label>
                                    <label class="form-label" v-else>购买比例 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="recordForm.sell_percentage" step="0.01" min="0" max="1" required>
                                    <div class="form-text">0.1 = 10%, 1 = 100%</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">通知Webhook地址 <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" v-model="recordForm.webhook_url" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">执行模式 <span class="text-danger">*</span></label>
                                    <select class="form-select" v-model="recordForm.execution_mode" required>
                                        <option value="single">单次执行</option>
                                        <option value="multiple">多次执行</option>
                                    </select>
                                    <div class="form-text" v-if="recordForm.type === 'sell'">单次执行：达到阈值后按比例出售并停止监控；多次执行：可部分出售并继续监控</div>
                                    <div class="form-text" v-else>单次执行：低于阈值后按比例买入并停止监控；多次执行：可部分买入并继续监控</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" v-if="recordForm.type === 'sell'">
                                    <label class="form-label">最低持仓金额(USD)</label>
                                    <input type="number" class="form-control" v-model="recordForm.minimum_hold_value"
                                           step="0.01" min="0" :disabled="recordForm.execution_mode === 'single'">
                                    <div class="form-text">多次执行模式下，当持仓价值低于此金额时将100%出售</div>
                                </div>
                                <div class="mb-3" v-else>
                                    <label class="form-label">最低SOL保留金额(USD)</label>
                                    <input type="number" class="form-control" v-model="recordForm.minimum_hold_value"
                                           step="0.01" min="0" :disabled="recordForm.execution_mode === 'single'">
                                    <div class="form-text">多次执行模式下，SOL价值低于此金额时全部买入</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3" v-if="recordForm.type === 'buy'">
                            <label class="form-label">累计购买上限(USD)</label>
                            <input type="number" class="form-control" v-model="recordForm.max_buy_amount" step="0.01" min="0">
                            <div class="form-text">达到此金额后自动停止买入，0表示不限制</div>
                        </div>
                        <div class="mb-3" v-if="recordForm.type === 'sell'">
                            <label class="form-label">是否开启预抢购模式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preSniperMode" v-model="recordForm.pre_sniper_mode">
                                <label class="form-check-label" for="preSniperMode">
                                    开启后，达到阈值但余额不足时不会停止监控，而是跳过本次，等待下次再判断余额（默认关闭）
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
                            <button type="submit" class="btn btn-primary" :disabled="saveLoading">
                                <span v-if="saveLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="saveLoading">保存中...</span>
                                <span v-else>保存</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑波段监控记录模态框 -->
    <div class="modal fade" :class="{ show: showAddSwingModal || showEditSwingModal }"
         :style="{ display: showAddSwingModal || showEditSwingModal ? 'block' : 'none' }"
         @click="closeSwingModal">
        <div class="modal-dialog modal-lg" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt me-2"></i>
                        <span v-if="showEditSwingModal">编辑波段监控记录</span>
                        <span v-else>添加波段监控记录</span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeSwingModal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveSwingRecord">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">监控名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="swingForm.name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">检查间隔(秒) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="swingForm.check_interval" min="1" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">选择钱包私钥 <span class="text-danger">*</span></label>
                            <select class="form-select" v-model="swingForm.private_key_id" required>
                                <option value="">请选择钱包私钥</option>
                                <option v-for="key in privateKeys" :key="key.id" :value="key.id" v-text="key.nickname + ' (' + key.public_key.substring(0,8) + '...' + key.public_key.substring(key.public_key.length-8) + ')'">
                                </option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                如果列表为空，请先到
                                <a href="/keys" target="_blank" class="text-decoration-none">私钥管理</a>
                                页面添加私钥
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 position-relative">
                                    <label class="form-label">监听代币地址 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="swingForm.watch_token_address"
                                           @input="onWatchTokenAddressInput" @focus="onWatchTokenAddressInput" @blur="onWatchTokenAddressBlur"
                                           required placeholder="要监听价格的代币地址" autocomplete="off">
                                    <div v-if="showWatchTokenDropdown && (filteredWatchTokenList.length > 0 || tokensLoading)"
                                         class="dropdown-menu show w-100 mt-1"
                                         style="max-height:260px;overflow:auto;z-index:1050;">
                                        <div v-if="tokensLoading" class="dropdown-item text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                            <span class="text-muted">加载代币列表中...</span>
                                        </div>
                                        <div v-else-if="filteredWatchTokenList.length === 0" class="dropdown-item text-center py-3 text-muted">
                                            <i class="fas fa-search me-2"></i>
                                            <span>未找到匹配的代币</span>
                                        </div>
                                        <div v-else v-for="token in filteredWatchTokenList" :key="token.address"
                                             class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer;"
                                             @mousedown.prevent="selectWatchToken(token)">
                                            <img v-if="token.logo_uri" :src="token.logo_uri" style="width:20px;height:20px;"
                                                 class="rounded-circle">
                                            <span class="fw-bold" v-text="token.name"></span>
                                            <span class="badge bg-secondary ms-2" v-text="token.symbol"></span>
                                            <span class="text-muted ms-auto small"
                                                  v-text="token.address.substring(0,6)+'...'+token.address.substring(token.address.length-6)"></span>
                                        </div>
                                    </div>
                                    <div v-if="selectedWatchTokenInfo" class="form-text mt-2">
                                        <div class="d-flex align-items-center">
                                            <img v-if="selectedWatchTokenInfo.logo_uri" :src="selectedWatchTokenInfo.logo_uri"
                                                 alt="token logo" class="me-2 rounded-circle"
                                                 style="width: 24px; height: 24px;"
                                                 @error="$event.target.style.display='none'">
                                            <span class="fw-bold me-2" v-text="selectedWatchTokenInfo.name || '未知'"></span>
                                            <span class="badge bg-secondary" v-text="selectedWatchTokenInfo.symbol || 'N/A'"></span>
                                        </div>
                                    </div>
                                    <div class="form-text">系统将监听此代币的价格变化</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 position-relative">
                                    <label class="form-label">交易代币地址 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="swingForm.trade_token_address"
                                           @input="onTradeTokenAddressInput" @focus="onTradeTokenAddressInput" @blur="onTradeTokenAddressBlur"
                                           required placeholder="要进行交易的代币地址" autocomplete="off">
                                    <div v-if="showTradeTokenDropdown && (filteredTradeTokenList.length > 0 || tokensLoading)"
                                         class="dropdown-menu show w-100 mt-1"
                                         style="max-height:260px;overflow:auto;z-index:1050;">
                                        <div v-if="tokensLoading" class="dropdown-item text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                            <span class="text-muted">加载代币列表中...</span>
                                        </div>
                                        <div v-else-if="filteredTradeTokenList.length === 0" class="dropdown-item text-center py-3 text-muted">
                                            <i class="fas fa-search me-2"></i>
                                            <span>未找到匹配的代币</span>
                                        </div>
                                        <div v-else v-for="token in filteredTradeTokenList" :key="token.address"
                                             class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer;"
                                             @mousedown.prevent="selectTradeToken(token)">
                                            <img v-if="token.logo_uri" :src="token.logo_uri" style="width:20px;height:20px;"
                                                 class="rounded-circle">
                                            <span class="fw-bold" v-text="token.name"></span>
                                            <span class="badge bg-secondary ms-2" v-text="token.symbol"></span>
                                            <span class="text-muted ms-auto small"
                                                  v-text="token.address.substring(0,6)+'...'+token.address.substring(token.address.length-6)"></span>
                                        </div>
                                    </div>
                                    <div v-if="selectedTradeTokenInfo" class="form-text mt-2">
                                        <div class="d-flex align-items-center">
                                            <img v-if="selectedTradeTokenInfo.logo_uri" :src="selectedTradeTokenInfo.logo_uri"
                                                 alt="token logo" class="me-2 rounded-circle"
                                                 style="width: 24px; height: 24px;"
                                                 @error="$event.target.style.display='none'">
                                            <span class="fw-bold me-2" v-text="selectedTradeTokenInfo.name || '未知'"></span>
                                            <span class="badge bg-secondary" v-text="selectedTradeTokenInfo.symbol || 'N/A'"></span>
                                        </div>
                                    </div>
                                    <div class="form-text">系统将在此代币和监听代币之间进行交易</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">价格类型 <span class="text-danger">*</span></label>
                            <select class="form-select" v-model="swingForm.price_type" required>
                                <option value="market_cap">市值</option>
                                <option value="price">单价</option>
                            </select>
                            <div class="form-text">选择监听代币的价格类型</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">买入阈值(USD) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="swingForm.buy_threshold"
                                           step="0.01" min="0" required>
                                    <div class="form-text">监听代币价格低于此值时买入</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">卖出阈值(USD) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="swingForm.sell_threshold"
                                           step="0.01" min="0" required>
                                    <div class="form-text">监听代币价格高于此值时卖出</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">买入比例 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="swingForm.buy_percentage"
                                           step="0.01" min="0" max="1" required>
                                    <div class="form-text">0.1 = 10%, 1 = 100%</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">卖出比例 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" v-model="swingForm.sell_percentage"
                                           step="0.01" min="0" max="1" required>
                                    <div class="form-text">0.1 = 10%, 1 = 100%</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">通知Webhook地址 <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" v-model="swingForm.webhook_url" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">全仓操作阈值(USD)</label>
                            <input type="number" class="form-control" v-model="swingForm.all_in_threshold"
                                   step="0.01" min="0">
                            <div class="form-text">当资产价值低于此金额时进行全仓操作</div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeSwingModal">取消</button>
                            <button type="submit" class="btn btn-primary" :disabled="saveLoading">
                                <span v-if="saveLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="saveLoading">保存中...</span>
                                <span v-else>保存</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志查看模态框（原生渲染） -->
    <div class="modal fade" :class="{ show: showLogsModal }" :style="{ display: showLogsModal ? 'block' : 'none' }" @click="closeLogsModal">
        <div class="modal-dialog modal-xl" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>
                        监控日志
                    </h5>
                    <button type="button" class="btn-close" @click="closeLogsModal"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- 过滤器 -->
                    <div class="p-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <label class="form-label mb-2">筛选操作类型</label>
                                <div class="d-flex gap-1">
                                    <button type="button" 
                                            class="btn btn-sm px-2 py-1"
                                            style="font-size: 0.75rem;"
                                            :class="selectedActionTypes.includes('monitoring') ? 'btn-primary' : 'btn-outline-primary'"
                                            @click="toggleActionType('monitoring')">
                                        <i class="fas fa-eye me-1"></i>监控中
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm px-2 py-1"
                                            style="font-size: 0.75rem;"
                                            :class="selectedActionTypes.includes('sell') ? 'btn-warning' : 'btn-outline-warning'"
                                            @click="toggleActionType('sell')">
                                        <i class="fas fa-arrow-down me-1"></i>卖出
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm px-2 py-1"
                                            style="font-size: 0.75rem;"
                                            :class="selectedActionTypes.includes('buy') ? 'btn-success' : 'btn-outline-success'"
                                            @click="toggleActionType('buy')">
                                        <i class="fas fa-arrow-up me-1"></i>买入
                                    </button>
                                </div>
                                <div class="form-text">点击选择要显示的操作类型，不选则显示所有类型</div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" @click="loadModalLogs">
                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': logsLoading }"></i>
                                    刷新
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-if="logsLoading" class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">加载日志中...</p>
                    </div>
                    <div v-else-if="logs.length === 0" class="text-center py-5">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted">暂无日志记录</p>
                    </div>
                    <div v-else class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>价格</th>
                                    <th>市值</th>
                                    <th>交易金额</th>
                                    <th>达到阈值</th>
                                    <th>操作</th>
                                    <th>交易哈希</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="log in logs" :key="log.id">
                                    <td>
                                        <small v-text="formatTime(log.timestamp)"></small>
                                    </td>
                                    <td>
                                        <span v-if="log.price" v-text="'$' + log.price.toFixed(8)"></span>
                                        <span v-else>--</span>
                                    </td>
                                    <td>
                                        <span v-if="log.market_cap" v-text="'$' + log.market_cap.toLocaleString()"></span>
                                        <span v-else>--</span>
                                    </td>
                                    <td>
                                        <span v-if="log.transaction_usd" v-text="'$' + log.transaction_usd.toLocaleString()"></span>
                                        <span v-else>--</span>
                                    </td>
                                    <td>
                                        <span class="badge" :class="log.threshold_reached ? 'bg-danger' : 'bg-success'">
                                            <span v-if="log.threshold_reached">是</span>
                                            <span v-else>否</span>
                                        </span>
                                    </td>
                                    <td v-text="log.action_taken"></td>
                                    <td>
                                        <span v-if="log.tx_hash">
                                            <a :href="'https://solscan.io/tx/' + log.tx_hash" target="_blank" class="text-decoration-none">
                                                <code class="small" v-text="log.tx_hash.substring(0, 8) + '...'"></code>
                                                <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                        </span>
                                        <span v-else>--</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框背景 -->
    <div v-if="showAddModal || showEditModal || showLogsModal || showAddSwingModal || showEditSwingModal" class="modal-backdrop fade show"></div>

    <!-- 消息提示 -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div v-for="message in messages" :key="message.id"
             class="toast align-items-center border-0 show mb-2"
             :class="message.type === 'success' ? 'text-bg-success' : 'text-bg-danger'">
            <div class="d-flex">
                <div class="toast-body" v-text="message.text">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        @click="removeMessage(message.id)"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const { createApp } = Vue;

function formatShortNumber(num) {
    if (num === null || num === undefined) return '--';
    num = Math.abs(num);
    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'm';
    if (num >= 1e3) return (num / 1e3).toFixed(2) + 'k';
    return num.toLocaleString(undefined, {maximumFractionDigits: 2});
}

const defaultRecordForm = {
    name: '',
    private_key_id: '',
    token_address: '',
    threshold: 200000,
    sell_percentage: 0.1,
    webhook_url: '',
    check_interval: 60,
    execution_mode: 'single',
    minimum_hold_value: 50.0,
    pre_sniper_mode: false,
    type: 'sell',
    max_buy_amount: 0.0
};

createApp({
    data() {
        return {
            monitorRecords: [],
            swingRecords: [],
            privateKeys: [],
            logs: [],
            loading: true,
            logsLoading: false,
            saveLoading: false,
            showAddModal: false,
            showEditModal: false,
            showLogsModal: false,
            editingRecordId: null,
            operationLoading: {},
            swingOperationLoading: {},
            tokenAddressError: '',
            recordForm: { ...defaultRecordForm },
            messages: [],
            availableTokens: [], // 可用的代币列表
            showTokenDropdown: false,
            filteredTokenList: [],
            tokensLoading: false,
            selectedTokenInfo: null, // 选中的代币信息
            showAddSwingModal: false,
            showEditSwingModal: false,
            swingForm: {
                name: '',
                private_key_id: '',
                watch_token_address: '',
                trade_token_address: '',
                price_type: 'market_cap',
                buy_threshold: 0,
                sell_threshold: 0,
                buy_percentage: 0.1,
                sell_percentage: 0.1,
                webhook_url: '',
                check_interval: 60,
                all_in_threshold: 0,
                type: 'swing' // 区分普通监控和波段监控
            },
            // 波段监控代币选择相关
            showWatchTokenDropdown: false,
            showTradeTokenDropdown: false,
            filteredWatchTokenList: [],
            filteredTradeTokenList: [],
            selectedWatchTokenInfo: null,
            selectedTradeTokenInfo: null,
            logsType: '',
            logsRecordId: null,
            selectedActionTypes: [], // 选中的操作类型过滤
        }
    },
    computed: {
        sellRecords() {
            return this.monitorRecords.filter(r => r.type === 'sell');
        },
        buyRecords() {
            return this.monitorRecords.filter(r => r.type === 'buy');
        },
        runningCount() {
            return this.monitorRecords.filter(r => r.status === 'monitoring').length +
                   this.swingRecords.filter(r => r.status === 'monitoring').length;
        },
        stoppedCount() {
            return this.monitorRecords.filter(r => r.status === 'stopped').length +
                   this.swingRecords.filter(r => r.status === 'stopped').length;
        },
        errorCount() {
            return this.monitorRecords.filter(r => r.status === 'error').length +
                   this.swingRecords.filter(r => r.status === 'error').length;
        }
    },
    mounted() {
        this.loadMonitorRecords();
        this.loadSwingRecords();
        this.loadPrivateKeys();
        // 每30秒自动刷新
        setInterval(() => {
            this.loadMonitorRecords();
            this.loadSwingRecords();
        }, 30000);
    },
    methods: {
        formatShortNumber(num) {
            if (num === null || num === undefined) return '--';
            num = Math.abs(num);
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'm';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'k';
            return num.toLocaleString(undefined, {maximumFractionDigits: 2});
        },
        async loadMonitorRecords() {
            try {
                const response = await ApiClient.get('/api/monitor/records');
                ApiResponse.handle(response,
                    (data) => {
                        this.monitorRecords = data;
                    },
                    (error) => {
                        this.showMessage('error', error || '加载监控记录失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.loading = false;
            }
        },
        async loadSwingRecords() {
            try {
                const response = await ApiClient.get('/api/swing/records');
                ApiResponse.handle(response,
                    (data) => {
                        this.swingRecords = data;
                    },
                    (error) => {
                        this.showMessage('error', error || '加载波段监控记录失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.loading = false; // 确保loading状态正确
            }
        },
        async loadPrivateKeys() {
            try {
                const response = await ApiClient.get('/api/keys');
                ApiResponse.handle(response,
                    (data) => {
                        this.privateKeys = data;
                    },
                    (error) => {
                        this.showMessage('error', error || '加载私钥列表失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            }
        },
        async saveRecord() {
            this.saveLoading = true;
            this.tokenAddressError = ''; // 清空之前的错误
            try {
                const formData = new FormData();
                // 确保threshold为数字
                formData.append('threshold', parseFloat(this.recordForm.threshold) || 0);
                Object.keys(this.recordForm).forEach(key => {
                    if (key !== 'threshold') formData.append(key, this.recordForm[key]);
                });

                const url = this.showEditModal
                    ? `/api/monitor/records/${this.editingRecordId}`
                    : '/api/monitor/records';

                const method = this.showEditModal ? 'PUT' : 'POST';

                const response = await ApiClient[method.toLowerCase()](url, formData);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '保存成功');
                        this.closeModal();
                        this.loadMonitorRecords();
                    },
                    (error) => {
                        // 检查是否是token相关错误
                        if (error && (error.includes('Token') || error.includes('代币') || error.includes('token'))) {
                            this.tokenAddressError = error;
                        } else {
                            this.showMessage('error', error || '保存失败');
                        }
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.saveLoading = false;
            }
        },
        async startMonitor(recordId) {
            this.operationLoading[recordId] = true;
            try {
                const response = await ApiClient.post(`/api/monitor/start?record_id=${recordId}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '启动成功');
                        this.loadMonitorRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '启动失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.operationLoading[recordId] = false;
            }
        },
        async stopMonitor(recordId) {
            this.operationLoading[recordId] = true;
            try {
                const response = await ApiClient.post(`/api/monitor/stop?record_id=${recordId}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '停止成功');
                        this.loadMonitorRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '停止失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.operationLoading[recordId] = false;
            }
        },
        async deleteRecord(recordId) {
            if (!confirm('确定要删除这个监控记录吗？此操作不可恢复。')) {
                return;
            }

            try {
                const response = await ApiClient.delete(`/api/monitor/records/${recordId}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '删除成功');
                        this.loadMonitorRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '删除失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            }
        },
        async startSwingMonitor(recordId) {
            this.swingOperationLoading[recordId] = true;
            try {
                const formData = new FormData();
                formData.append('record_id', recordId);
                const response = await ApiClient.post(`/api/swing/start`, formData);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '启动波段监控成功');
                        this.loadSwingRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '启动波段监控失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.swingOperationLoading[recordId] = false;
            }
        },
        async stopSwingMonitor(recordId) {
            this.swingOperationLoading[recordId] = true;
            try {
                const formData = new FormData();
                formData.append('record_id', recordId);
                const response = await ApiClient.post(`/api/swing/stop`, formData);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '停止波段监控成功');
                        this.loadSwingRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '停止波段监控失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.swingOperationLoading[recordId] = false;
            }
        },
        async deleteSwingRecord(recordId) {
            if (!confirm('确定要删除这个波段监控记录吗？此操作不可恢复。')) {
                return;
            }

            try {
                const response = await ApiClient.delete(`/api/swing/records/${recordId}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '删除波段监控成功');
                        this.loadSwingRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '删除波段监控失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            }
        },
        async editSwingRecord(record) {
            this.swingForm = {
                id: record.id,
                name: record.name,
                private_key_id: record.private_key_id,
                watch_token_address: record.watch_token_address,
                trade_token_address: record.trade_token_address,
                price_type: record.price_type,
                buy_threshold: record.buy_threshold,
                sell_threshold: record.sell_threshold,
                buy_percentage: record.buy_percentage,
                sell_percentage: record.sell_percentage,
                webhook_url: record.webhook_url,
                check_interval: record.check_interval,
                all_in_threshold: record.all_in_threshold || 0,
                type: 'swing'
            };

            // 懒加载代币列表
            if (this.availableTokens.length === 0) {
                await this.loadAvailableTokens();
            }

            // 获取代币信息
            if (this.swingForm.watch_token_address) {
                await this.fetchWatchTokenInfo();
            }
            if (this.swingForm.trade_token_address) {
                await this.fetchTradeTokenInfo();
            }

            this.showEditSwingModal = true;
        },
        async editRecord(record) {
            this.editingRecordId = record.id;
            this.tokenAddressError = '';
            Object.keys(this.recordForm).forEach(key => {
                this.recordForm[key] = record[key] !== undefined ? record[key] : defaultRecordForm[key];
            });
            this.showEditModal = true;
            // 懒加载代币列表
            if (this.availableTokens.length === 0) {
                await this.loadAvailableTokens();
            }
            // 如果已有代币地址，获取代币信息
            if (this.recordForm.token_address) {
                await this.fetchTokenInfo();
            }
        },
        async viewLogs(type, recordId) {
            this.showLogsModal = true;
            this.logsType = type;
            this.logsRecordId = recordId;
            this.selectedActionTypes = []; // 重置过滤器
            this.loadModalLogs();
        },
        toggleActionType(type) {
            const index = this.selectedActionTypes.indexOf(type);
            if (index > -1) {
                this.selectedActionTypes.splice(index, 1);
            } else {
                this.selectedActionTypes.push(type);
            }
            this.loadModalLogs();
        },
        async loadModalLogs() {
            this.logsLoading = true;
            try {
                let url = `/api/logs?type=${this.logsType}&monitor_record_id=${this.logsRecordId}&per_page=50`;
                if (this.selectedActionTypes.length > 0) {
                    // 将数组转换为逗号分割的字符串
                    url += `&action_types=${this.selectedActionTypes.join(',')}`;
                }
                const response = await ApiClient.get(url);
                ApiResponse.handle(response,
                    (data) => {
                        this.logs = data.logs;
                    },
                    (error) => {
                        this.logs = [];
                    }
                );
            } catch (error) {
                this.logs = [];
            } finally {
                this.logsLoading = false;
            }
        },
        closeModal() {
            this.showAddModal = false;
            this.showEditModal = false;
            this.editingRecordId = null;
            this.tokenAddressError = '';
            this.showTokenDropdown = false;
            this.filteredTokenList = [];
            this.selectedTokenInfo = null;
            Object.keys(this.recordForm).forEach(key => {
                this.recordForm[key] = defaultRecordForm[key];
            });
        },
        closeSwingModal() {
            this.showAddSwingModal = false;
            this.showEditSwingModal = false;
            // 重置代币选择相关状态
            this.showWatchTokenDropdown = false;
            this.showTradeTokenDropdown = false;
            this.filteredWatchTokenList = [];
            this.filteredTradeTokenList = [];
            this.selectedWatchTokenInfo = null;
            this.selectedTradeTokenInfo = null;
            this.swingForm = {
                name: '',
                private_key_id: '',
                watch_token_address: '',
                trade_token_address: '',
                price_type: 'market_cap',
                buy_threshold: 0,
                sell_threshold: 0,
                buy_percentage: 0.1,
                sell_percentage: 0.1,
                webhook_url: '',
                check_interval: 60,
                all_in_threshold: 0,
                type: 'swing'
            };
        },
        closeLogsModal() {
            this.showLogsModal = false;
            this.logs = [];
            this.logsType = '';
            this.logsRecordId = null;
            this.selectedActionTypes = [];
        },
        getStatusClass(status) {
            const statusClasses = {
                'monitoring': 'bg-success',
                'stopped': 'bg-secondary',
                'error': 'bg-danger',
                'completed': 'bg-info'
            };
            return statusClasses[status] || 'bg-secondary';
        },
        getStatusIcon(status) {
            const statusIcons = {
                'monitoring': 'fa-play',
                'stopped': 'fa-stop',
                'error': 'fa-exclamation-triangle',
                'completed': 'fa-check-circle'
            };
            return statusIcons[status] || 'fa-question';
        },
        getStatusText(status) {
            const statusTexts = {
                'monitoring': '监控中',
                'stopped': '已停止',
                'error': '错误',
                'completed': '已完成'
            };
            return statusTexts[status] || '?未知';
        },
        formatTime(timestamp) {
            if (!timestamp) return '--';
            return new Date(timestamp).toLocaleString('zh-CN');
        },
        showMessage(type, text) {
            const id = Date.now() + Math.random();
            this.messages.push({ id, type, text });
            setTimeout(() => {
                this.removeMessage(id);
            }, 5000);
        },
        removeMessage(id) {
            this.messages = this.messages.filter(m => m.id !== id);
        },
        copyToClipboard(text, type) {
            // 优先使用现代 Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('success', `${type}已复制到剪贴板`);
                }).catch(err => {
                    console.error('Clipboard API 失败:', err);
                    this.fallbackCopyTextToClipboard(text, type);
                });
            } else {
                // 使用备用方案
                this.fallbackCopyTextToClipboard(text, type);
            }
        },
        fallbackCopyTextToClipboard(text, type) {
            // 创建临时文本区域
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);

            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    this.showMessage('success', `${type}已复制到剪贴板`);
                } else {
                    this.showMessage('error', '复制失败，请手动复制');
                }
            } catch (err) {
                console.error('备用复制方法失败:', err);
                this.showMessage('error', '复制失败，请手动复制');
            } finally {
                document.body.removeChild(textArea);
            }
        },
        getThresholdDiffHtml(record) {
            if (!record.last_market_cap || !record.threshold) return '--';
            if (record.last_market_cap < record.threshold) {
                const diff = record.threshold - record.last_market_cap;
                const percent = ((diff / record.last_market_cap) * 100).toFixed(2);
                return `<div><span class='fw-bold text-danger'>还需涨 $${formatShortNumber(diff)}</span><div class='small text-secondary mt-1'>(${percent}%)</div></div>`;
            } else {
                const diff = record.last_market_cap - record.threshold;
                const percent = ((diff / record.threshold) * 100).toFixed(2);
                return `<div><span class='fw-bold text-success'>已超阈值 $${formatShortNumber(diff)}</span><div class='small text-secondary mt-1'>(${percent}%)</div></div>`;
            }
        },
        onThresholdInput(e) {
            // 只允许数字和小数点，防止输入异常变0
            let val = e.target.value.replace(/[^\d.]/g, '');
            if (val.split('.').length > 2) val = val.replace(/\.+$/, '');
            this.recordForm.threshold = val;
        },
        async openAddModal(type) {
            if (type === 'swing') {
                this.showAddSwingModal = true;
                // 懒加载代币列表
                if (this.availableTokens.length === 0) {
                    await this.loadAvailableTokens();
                }
                return;
            }
            this.recordForm.type = type; // 设置监控类型
            this.showAddModal = true;
            // 懒加载代币列表
            if (this.availableTokens.length === 0) {
                await this.loadAvailableTokens();
            }
            // 如果已有代币地址，获取代币信息
            if (this.recordForm.token_address) {
                await this.fetchTokenInfo();
            }
        },
        async loadAvailableTokens() {
            if (this.tokensLoading) return;
            this.tokensLoading = true;
            try {
                const response = await ApiClient.get('/api/keys/summary/tokens');
                ApiResponse.handle(response,
                    (data) => {
                        this.availableTokens = data.tokens || [];
                        // 加载完成后重新触发过滤
                        this.onTokenAddressInput();
                    },
                    (error) => {
                        this.showMessage('error', error || '加载代币列表失败');
                        this.showTokenDropdown = false;
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
                this.showTokenDropdown = false;
            } finally {
                this.tokensLoading = false;
            }
        },
        onTokenAddressInput() {
            this.tokenAddressError = '';
            const query = this.recordForm.token_address.trim().toLowerCase();

            // 如果输入为空，重置代币信息
            if (!query) {
                this.selectedTokenInfo = null;
            }

            // 如果代币列表为空且不在加载中，显示加载状态
            if (this.availableTokens.length === 0 && !this.tokensLoading) {
                this.showTokenDropdown = true;
                this.loadAvailableTokens();
                return;
            }

            if (query) {
                this.filteredTokenList = this.availableTokens.filter(token =>
                    token.address.toLowerCase().includes(query) ||
                    (token.name && token.name.toLowerCase().includes(query)) ||
                    (token.symbol && token.symbol.toLowerCase().includes(query))
                );
            } else {
                this.filteredTokenList = this.availableTokens;
            }

            this.showTokenDropdown = this.filteredTokenList.length > 0 || this.tokensLoading;
        },
        selectToken(token) {
            this.recordForm.token_address = token.address;
            this.showTokenDropdown = false;
            this.tokenAddressError = '';
            this.selectedTokenInfo = {
                name: token.name,
                symbol: token.symbol,
                logo_uri: token.logo_uri
            };
        },
        onTokenAddressBlur() {
            setTimeout(() => {
                this.showTokenDropdown = false;
                // 如果用户手动输入了地址，尝试获取代币信息
                if (this.recordForm.token_address && !this.selectedTokenInfo) {
                    this.fetchTokenInfo();
                }
            }, 200);
        },
        async fetchTokenInfo() {
            if (!this.recordForm.token_address) {
                this.selectedTokenInfo = null;
                return;
            }

            // 首先检查是否在已有的代币列表中
            const existingToken = this.availableTokens.find(token =>
                token.address.toLowerCase() === this.recordForm.token_address.toLowerCase()
            );

            if (existingToken) {
                this.selectedTokenInfo = {
                    name: existingToken.name,
                    symbol: existingToken.symbol,
                    logo_uri: existingToken.logo_uri
                };
                return;
            }

            // 如果不在列表中，调用API获取
            try {
                const response = await ApiClient.get(`/api/token_info?address=${this.recordForm.token_address}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.selectedTokenInfo = {
                            name: data.name,
                            symbol: data.symbol,
                            logo_uri: data.logo_uri
                        };
                    },
                    (error) => {
                        // 获取失败时不显示错误，只是不显示代币信息
                        this.selectedTokenInfo = null;
                    }
                );
            } catch (error) {
                this.selectedTokenInfo = null;
            }
        },
        async saveSwingRecord() {
            this.saveLoading = true;
            try {
                const formData = new FormData();

                // 添加所有必需的字段
                formData.append('name', this.swingForm.name);
                formData.append('private_key_id', this.swingForm.private_key_id);
                formData.append('watch_token_address', this.swingForm.watch_token_address);
                formData.append('trade_token_address', this.swingForm.trade_token_address);
                formData.append('price_type', this.swingForm.price_type);
                formData.append('buy_threshold', this.swingForm.buy_threshold);
                formData.append('sell_threshold', this.swingForm.sell_threshold);
                formData.append('buy_percentage', this.swingForm.buy_percentage);
                formData.append('sell_percentage', this.swingForm.sell_percentage);
                formData.append('webhook_url', this.swingForm.webhook_url);
                formData.append('check_interval', this.swingForm.check_interval);
                formData.append('all_in_threshold', this.swingForm.all_in_threshold || 50.0);

                const url = this.showEditSwingModal
                    ? `/api/swing/records/${this.swingForm.id}`
                    : '/api/swing/records';

                const method = this.showEditSwingModal ? 'PUT' : 'POST';

                const response = await ApiClient[method.toLowerCase()](url, formData);
                ApiResponse.handle(response,
                    (data) => {
                        this.showMessage('success', response.message || '保存成功');
                        this.closeSwingModal();
                        this.loadSwingRecords();
                    },
                    (error) => {
                        this.showMessage('error', error || '保存失败');
                    }
                );
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.saveLoading = false;
            }
        },
        // 波段监控代币选择相关方法
        onWatchTokenAddressInput() {
            const query = this.swingForm.watch_token_address.trim().toLowerCase();

            // 如果输入为空，重置代币信息
            if (!query) {
                this.selectedWatchTokenInfo = null;
            }

            // 如果代币列表为空且不在加载中，显示加载状态
            if (this.availableTokens.length === 0 && !this.tokensLoading) {
                this.showWatchTokenDropdown = true;
                this.loadAvailableTokens();
                return;
            }

            if (query) {
                this.filteredWatchTokenList = this.availableTokens.filter(token =>
                    token.address.toLowerCase().includes(query) ||
                    (token.name && token.name.toLowerCase().includes(query)) ||
                    (token.symbol && token.symbol.toLowerCase().includes(query))
                );
            } else {
                this.filteredWatchTokenList = this.availableTokens;
            }

            this.showWatchTokenDropdown = this.filteredWatchTokenList.length > 0 || this.tokensLoading;
        },
        onWatchTokenAddressBlur() {
            setTimeout(() => {
                this.showWatchTokenDropdown = false;
                // 如果用户手动输入了地址，尝试获取代币信息
                if (this.swingForm.watch_token_address && !this.selectedWatchTokenInfo) {
                    this.fetchWatchTokenInfo();
                }
            }, 200);
        },
        selectWatchToken(token) {
            this.swingForm.watch_token_address = token.address;
            this.showWatchTokenDropdown = false;
            this.selectedWatchTokenInfo = {
                name: token.name,
                symbol: token.symbol,
                logo_uri: token.logo_uri
            };
        },
        async fetchWatchTokenInfo() {
            if (!this.swingForm.watch_token_address) {
                this.selectedWatchTokenInfo = null;
                return;
            }

            // 首先检查是否在已有的代币列表中
            const existingToken = this.availableTokens.find(token =>
                token.address.toLowerCase() === this.swingForm.watch_token_address.toLowerCase()
            );

            if (existingToken) {
                this.selectedWatchTokenInfo = {
                    name: existingToken.name,
                    symbol: existingToken.symbol,
                    logo_uri: existingToken.logo_uri
                };
                return;
            }

            // 如果不在列表中，调用API获取
            try {
                const response = await ApiClient.get(`/api/token_info?address=${this.swingForm.watch_token_address}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.selectedWatchTokenInfo = {
                            name: data.name,
                            symbol: data.symbol,
                            logo_uri: data.logo_uri
                        };
                    },
                    (error) => {
                        this.selectedWatchTokenInfo = null;
                    }
                );
            } catch (error) {
                this.selectedWatchTokenInfo = null;
            }
        },
        onTradeTokenAddressInput() {
            const query = this.swingForm.trade_token_address.trim().toLowerCase();

            // 如果输入为空，重置代币信息
            if (!query) {
                this.selectedTradeTokenInfo = null;
            }

            // 如果代币列表为空且不在加载中，显示加载状态
            if (this.availableTokens.length === 0 && !this.tokensLoading) {
                this.showTradeTokenDropdown = true;
                this.loadAvailableTokens();
                return;
            }

            if (query) {
                this.filteredTradeTokenList = this.availableTokens.filter(token =>
                    token.address.toLowerCase().includes(query) ||
                    (token.name && token.name.toLowerCase().includes(query)) ||
                    (token.symbol && token.symbol.toLowerCase().includes(query))
                );
            } else {
                this.filteredTradeTokenList = this.availableTokens;
            }

            this.showTradeTokenDropdown = this.filteredTradeTokenList.length > 0 || this.tokensLoading;
        },
        onTradeTokenAddressBlur() {
            setTimeout(() => {
                this.showTradeTokenDropdown = false;
                // 如果用户手动输入了地址，尝试获取代币信息
                if (this.swingForm.trade_token_address && !this.selectedTradeTokenInfo) {
                    this.fetchTradeTokenInfo();
                }
            }, 200);
        },
        selectTradeToken(token) {
            this.swingForm.trade_token_address = token.address;
            this.showTradeTokenDropdown = false;
            this.selectedTradeTokenInfo = {
                name: token.name,
                symbol: token.symbol,
                logo_uri: token.logo_uri
            };
        },
        async fetchTradeTokenInfo() {
            if (!this.swingForm.trade_token_address) {
                this.selectedTradeTokenInfo = null;
                return;
            }

            // 首先检查是否在已有的代币列表中
            const existingToken = this.availableTokens.find(token =>
                token.address.toLowerCase() === this.swingForm.trade_token_address.toLowerCase()
            );

            if (existingToken) {
                this.selectedTradeTokenInfo = {
                    name: existingToken.name,
                    symbol: existingToken.symbol,
                    logo_uri: existingToken.logo_uri
                };
                return;
            }

            // 如果不在列表中，调用API获取
            try {
                const response = await ApiClient.get(`/api/token_info?address=${this.swingForm.trade_token_address}`);
                ApiResponse.handle(response,
                    (data) => {
                        this.selectedTradeTokenInfo = {
                            name: data.name,
                            symbol: data.symbol,
                            logo_uri: data.logo_uri
                        };
                    },
                    (error) => {
                        this.selectedTradeTokenInfo = null;
                    }
                );
            } catch (error) {
                this.selectedTradeTokenInfo = null;
            }
        }
    }
}).mount('#app');
</script>
{% endblock %}
