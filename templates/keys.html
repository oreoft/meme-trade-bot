{% extends "base.html" %}

{% block title %}私钥管理 - 币价监控系统{% endblock %}

{% block content %}
<div id="app">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-0">
                        <i class="fas fa-key me-2 text-warning"></i>
                        私钥管理
                    </h1>
                    <p class="text-muted mb-0">统一管理您的钱包私钥</p>
                </div>
                <button class="btn btn-primary" @click="showAddModal = true">
                    <i class="fas fa-plus me-2"></i>添加私钥
                </button>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="privateKeys.length">0</h3>
                            <small>私钥总数</small>
                        </div>
                        <i class="fas fa-key fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="tokenSummary.total_sol.toFixed(2)">0</span>
                            </h3>
                            <small>总SOL数量</small>
                        </div>
                        <i class="fas fa-coins fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="'$' + tokenSummary.total_usd.toFixed(2)">$0</span>
                            </h3>
                            <small>总USD价值</small>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="tokenSummary.tokens.length">0</span>
                            </h3>
                            <small>Token种类</small>
                        </div>
                        <i class="fas fa-list fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Token汇总表格 -->
    <div class="row mb-4" v-if="tokenSummary.tokens.length > 0">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-coins me-2"></i>Token汇总
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" @click="refreshTokenSummary" :disabled="summaryLoading">
                            <span v-if="summaryLoading" class="spinner-border spinner-border-sm me-1"></span>
                            <i v-else class="fas fa-refresh me-1"></i>
                            <span v-if="summaryLoading">刷新中...</span>
                            <span v-else>刷新数据</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="summaryLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载汇总数据中...</p>
                    </div>
                    
                    <div v-else class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th>符号</th>
                                    <th>总持有量</th>
                                    <th>总价值</th>
                                    <th>Token地址</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="token in tokenSummary.tokens" :key="token.address">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img v-if="token.logo_uri" :src="token.logo_uri" 
                                                 alt="token logo" class="me-2 rounded-circle" 
                                                 style="width: 24px; height: 24px;"
                                                 @error="$event.target.style.display='none'">
                                            <span v-text="token.name"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary" v-text="token.symbol"></span>
                                    </td>
                                    <td v-text="formatAmount(token.total_amount)"></td>
                                    <td>
                                        <span class="text-success fw-bold" v-text="'$' + token.total_value.toFixed(2)"></span>
                                    </td>
                                    <td>
                                        <code class="small address-copy" 
                                              @click="copyToClipboard(token.address, 'Token地址')"
                                              :title="token.address + ' (点击复制)'"
                                              style="cursor: pointer; user-select: none;"
                                              v-text="token.address.substring(0, 8) + '...' + token.address.substring(token.address.length - 8)">
                                        </code>
                                        <i class="fas fa-copy ms-1 text-muted" style="font-size: 0.8em;"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 私钥列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>私钥列表
                        </h5>
                        <button class="btn btn-outline-danger btn-sm" 
                                @click="showExportModal = true"
                                :disabled="privateKeys.length === 0"
                                v-if="privateKeys.length > 0">
                            <i class="fas fa-download me-1"></i>导出私钥
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载中...</p>
                    </div>
                    
                    <div v-else-if="privateKeys.length === 0" class="text-center py-5">
                        <i class="fas fa-key fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无私钥记录</h5>
                        <p class="text-muted">点击"添加私钥"按钮添加第一个私钥</p>
                    </div>

                    <div v-else class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>昵称</th>
                                    <th>公钥地址</th>
                                    <th>私钥预览</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="key in privateKeys" :key="key.id">
                                    <td>
                                        <strong v-text="key.nickname"></strong>
                                    </td>
                                    <td>
                                        <code class="small address-copy" 
                                              @click="copyToClipboard(key.public_key, '公钥地址')"
                                              :title="key.public_key + ' (点击复制)'"
                                              style="cursor: pointer; user-select: none;"
                                              v-text="key.public_key.substring(0, 8) + '...' + key.public_key.substring(key.public_key.length - 8)">
                                        </code>
                                        <i class="fas fa-copy ms-1 text-muted" style="font-size: 0.8em;"></i>
                                    </td>
                                    <td>
                                        <code class="small text-muted" v-text="key.private_key_preview"></code>
                                    </td>
                                    <td>
                                        <small v-text="formatTime(key.created_at)"></small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button 
                                                class="btn btn-outline-primary"
                                                @click="editKey(key)"
                                                title="编辑">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button 
                                                class="btn btn-outline-danger"
                                                @click="deleteKey(key.id)"
                                                title="删除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑私钥模态框 -->
    <div class="modal fade" :class="{ show: showAddModal || showEditModal }" 
         :style="{ display: showAddModal || showEditModal ? 'block' : 'none' }"
         @click="closeModal">
        <div class="modal-dialog" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>
                        <span v-if="showEditModal">编辑私钥</span>
                        <span v-else>添加私钥</span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeModal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveKey">
                        <div class="mb-3">
                            <label class="form-label">私钥昵称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="keyForm.nickname" required>
                            <div class="form-text">给私钥起一个容易识别的名称</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">私钥 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <textarea class="form-control" rows="3" v-model="keyForm.private_key" required
                                          placeholder="请输入Solana钱包私钥 (Base58格式)"></textarea>
                                <button type="button" class="btn btn-outline-secondary generate-key-btn" 
                                        @click="generatePrivateKey" 
                                        :disabled="generateLoading || showEditModal"
                                        style="writing-mode: vertical-lr; text-orientation: mixed;"
                                        :title="showEditModal ? '编辑模式下不可生成' : '生成新私钥'">
                                    <span v-if="generateLoading" class="spinner-border spinner-border-sm"></span>
                                    <span v-else>
                                        <i class="fas fa-dice d-block mb-1"></i>
                                        <small>生成</small>
                                    </span>
                                </button>
                            </div>
                            <div class="form-text text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                私钥将被安全加密存储，请确保私钥来源安全可靠
                            </div>
                            <div class="form-text text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                点击"生成"按钮可以自动生成新的Solana私钥
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
                            <button type="submit" class="btn btn-primary" :disabled="saveLoading">
                                <span v-if="saveLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="saveLoading">保存中...</span>
                                <span v-else>保存</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 导出确认模态框 -->
    <div class="modal fade" :class="{ show: showExportModal }" 
         :style="{ display: showExportModal ? 'block' : 'none' }"
         @click="closeExportModal">
        <div class="modal-dialog modal-dialog-centered" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        导出私钥确认
                    </h5>
                    <button type="button" class="btn-close" @click="closeExportModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>安全警告</strong>
                        <p class="mb-0 mt-2">您即将导出包含完整私钥信息的敏感数据。请确保：</p>
                        <ul class="mt-2 mb-0">
                            <li>在安全的环境中操作</li>
                            <li>导出后妥善保管数据</li>
                            <li>不要在不安全的网络中传输</li>
                        </ul>
                    </div>
                    <form @submit.prevent="exportPrivateKeys">
                        <div class="mb-3">
                            <label class="form-label">请输入导出Token <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" v-model="exportToken" 
                                   placeholder="请输入导出验证token" required>
                            <div class="form-text">请联系管理员获取导出token</div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeExportModal">取消</button>
                            <button type="submit" class="btn btn-danger" :disabled="exportLoading">
                                <span v-if="exportLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <i v-else class="fas fa-download me-2"></i>
                                <span v-if="exportLoading">导出中...</span>
                                <span v-else>确认导出</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框背景 -->
    <div v-if="showAddModal || showEditModal || showExportModal" class="modal-backdrop fade show"></div>

    <!-- 消息提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div v-for="message in messages" :key="message.id" 
             class="toast align-items-center border-0 show mb-2" 
             :class="message.type === 'success' ? 'text-bg-success' : 'text-bg-danger'">
            <div class="d-flex">
                <div class="toast-body" v-text="message.text">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        @click="removeMessage(message.id)"></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            privateKeys: [],
            loading: true,
            saveLoading: false,
            generateLoading: false,
            exportLoading: false,
            summaryLoading: false,
            showAddModal: false,
            showEditModal: false,
            showExportModal: false,
            editingKeyId: null,
            keyForm: {
                nickname: '',
                private_key: ''
            },
            exportToken: '',
            messages: [],
            tokenSummary: {
                total_wallets: 0,
                total_sol: 0,
                total_usd: 0,
                tokens: []
            }
        }
    },
    mounted() {
        this.loadPrivateKeys();
        this.loadTokenSummary();
    },
    methods: {
        async loadPrivateKeys() {
            try {
                const response = await fetch('/api/keys');
                const data = await response.json();
                if (data.success) {
                    this.privateKeys = data.data;
                } else {
                    this.showMessage('error', data.error || '加载私钥失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.loading = false;
            }
        },
        async loadTokenSummary() {
            this.summaryLoading = true;
            try {
                const response = await fetch('/api/keys/summary/tokens');
                const data = await response.json();
                if (data.success) {
                    this.tokenSummary = data.data;
                } else {
                    this.showMessage('error', data.error || '加载Token汇总失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.summaryLoading = false;
            }
        },
        async refreshTokenSummary() {
            await this.loadTokenSummary();
            this.showMessage('success', 'Token汇总数据已刷新');
        },
        async saveKey() {
            this.saveLoading = true;
            try {
                const formData = new FormData();
                Object.keys(this.keyForm).forEach(key => {
                    formData.append(key, this.keyForm[key]);
                });

                const url = this.showEditModal 
                    ? `/api/keys/${this.editingKeyId}`
                    : '/api/keys';
                
                const method = this.showEditModal ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showMessage('success', data.message);
                    this.closeModal();
                    this.loadPrivateKeys();
                    this.loadTokenSummary();
                } else {
                    this.showMessage('error', data.error || '保存失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.saveLoading = false;
            }
        },
        async deleteKey(keyId) {
            if (!confirm('确定要删除这个私钥吗？删除后数据将被标记为删除状态（逻辑删除），相关的监控记录将无法使用。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/keys/${keyId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    this.showMessage('success', data.message);
                    this.loadPrivateKeys();
                    this.loadTokenSummary();
                } else {
                    this.showMessage('error', data.error || '删除失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            }
        },
        editKey(key) {
            this.editingKeyId = key.id;
            this.keyForm = {
                nickname: key.nickname,
                private_key: ''  // 安全起见，不回填私钥
            };
            this.showEditModal = true;
        },
        closeModal() {
            this.showAddModal = false;
            this.showEditModal = false;
            this.editingKeyId = null;
            this.keyForm = {
                nickname: '',
                private_key: ''
            };
        },
        formatTime(timestamp) {
            if (!timestamp) return '--';
            return new Date(timestamp).toLocaleString('zh-CN');
        },
        showMessage(type, text) {
            const id = Date.now() + Math.random();
            this.messages.push({ id, type, text });
            setTimeout(() => {
                this.removeMessage(id);
            }, 5000);
        },
        removeMessage(id) {
            this.messages = this.messages.filter(m => m.id !== id);
        },
        copyToClipboard(text, type) {
            // 优先使用现代 Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('success', `${type}已复制到剪贴板`);
                }).catch(err => {
                    console.error('Clipboard API 失败:', err);
                    this.fallbackCopyTextToClipboard(text, type);
                });
            } else {
                // 使用备用方案
                this.fallbackCopyTextToClipboard(text, type);
            }
        },
        fallbackCopyTextToClipboard(text, type) {
            // 创建临时文本区域
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            
            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    this.showMessage('success', `${type}已复制到剪贴板`);
                } else {
                    this.showMessage('error', '复制失败，请手动复制');
                }
            } catch (err) {
                console.error('备用复制方法失败:', err);
                this.showMessage('error', '复制失败，请手动复制');
            } finally {
                document.body.removeChild(textArea);
            }
        },
        async generatePrivateKey() {
            this.generateLoading = true;
            try {
                const response = await fetch('/api/keys/generate', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    this.keyForm.private_key = data.data.private_key;
                    this.showMessage('success', '私钥生成成功！公钥地址：' + data.data.public_key.substring(0, 8) + '...' + data.data.public_key.substring(data.data.public_key.length - 8));
                } else {
                    this.showMessage('error', data.error || '生成私钥失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.generateLoading = false;
            }
        },
        closeExportModal() {
            this.showExportModal = false;
            this.exportToken = '';
        },
        async exportPrivateKeys() {
            this.exportLoading = true;
            try {
                const formData = new FormData();
                formData.append('token', this.exportToken);
                
                const response = await fetch('/api/keys/export', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    // 创建下载文件
                    const jsonData = JSON.stringify(data.data, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // 创建临时下载链接
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `private_keys_export_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage('success', `导出成功！共导出 ${data.data.total_count} 个私钥`);
                    this.closeExportModal();
                } else {
                    this.showMessage('error', data.error || '导出失败');
                }
            } catch (error) {
                this.showMessage('error', '网络错误');
            } finally {
                this.exportLoading = false;
            }
        },
        formatAmount(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(2) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(2) + 'K';
            } else if (amount >= 1) {
                return amount.toFixed(2);
            } else {
                return amount.toFixed(6);
            }
        }
    }
}).mount('#app');
</script>
{% endblock %} 