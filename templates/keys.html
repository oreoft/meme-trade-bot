{% extends "base.html" %}

{% block title %}私钥管理 - 币价监控系统{% endblock %}

{% block content %}
<div id="app">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-0">
                        <i class="fas fa-key me-2 text-warning"></i>
                        私钥管理
                    </h1>
                    <p class="text-muted mb-0">统一管理您的钱包私钥</p>
                </div>
                <button class="btn btn-primary" @click="showAddModal = true">
                    <i class="fas fa-plus me-2"></i>添加私钥
                </button>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" v-text="privateKeys.length">0</h3>
                            <small>私钥总数</small>
                        </div>
                        <i class="fas fa-key fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="tokenSummary.total_sol.toFixed(2)">0</span>
                            </h3>
                            <small>总SOL数量</small>
                        </div>
                        <i class="fas fa-coins fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="'$' + tokenSummary.total_usd.toFixed(2)">$0</span>
                            </h3>
                            <small>总USD价值</small>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm"></span>
                                <span v-else v-text="tokenSummary.tokens.length">0</span>
                            </h3>
                            <small>Token种类</small>
                        </div>
                        <i class="fas fa-list fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Token汇总表格 -->
    <div class="row mb-4" v-if="tokenSummary.tokens.length > 0">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-coins me-2"></i>Token汇总
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <small v-if="isUsingCache" class="text-muted">
                                <i class="fas fa-clock me-1"></i>缓存数据
                            </small>
                            <button class="btn btn-outline-primary btn-sm" @click="refreshTokenSummary"
                                    :disabled="summaryLoading">
                                <span v-if="summaryLoading" class="spinner-border spinner-border-sm me-1"></span>
                                <i v-else class="fas fa-refresh me-1"></i>
                                <span v-if="summaryLoading">刷新中...</span>
                                <span v-else>刷新数据</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="summaryLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载汇总数据中...</p>
                    </div>

                    <div v-else class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Token</th>
                                <th>符号</th>
                                <th>总持有量</th>
                                <th>总价值</th>
                                <th>Token地址</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="token in tokenSummary.tokens" :key="token.address">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img v-if="token.logo_uri" :src="token.logo_uri"
                                             alt="token logo" class="me-2 rounded-circle"
                                             style="width: 24px; height: 24px;"
                                             @error="$event.target.style.display='none'">
                                        <a :href="'https://dexscreener.com/solana/' + token.address"
                                           target="_blank"
                                           class="text-decoration-none fw-bold text-primary"
                                           :title="'在DexScreener上查看 ' + token.name"
                                           v-text="token.name"></a>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary" v-text="token.symbol"></span>
                                </td>
                                <td v-text="formatAmount(token.total_amount)"></td>
                                <td>
                                    <span class="text-success fw-bold"
                                          v-text="'$' + token.total_value.toFixed(2)"></span>
                                </td>
                                <td>
                                    <code class="small address-copy"
                                          @click="copyToClipboard(token.address, 'Token地址')"
                                          :title="token.address + ' (点击复制)'"
                                          style="cursor: pointer; user-select: none;"
                                          v-text="token.address.substring(0, 8) + '...' + token.address.substring(token.address.length - 8)">
                                    </code>
                                    <i class="fas fa-copy ms-1 text-muted" style="font-size: 0.8em;"></i>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 私钥列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>私钥列表
                        </h5>
                        <button class="btn btn-outline-danger btn-sm"
                                @click="showExportModal = true"
                                :disabled="privateKeys.length === 0"
                                v-if="privateKeys.length > 0">
                            <i class="fas fa-download me-1"></i>导出私钥
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载中...</p>
                    </div>

                    <div v-else-if="privateKeys.length === 0" class="text-center py-5">
                        <i class="fas fa-key fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无私钥记录</h5>
                        <p class="text-muted">点击"添加私钥"按钮添加第一个私钥</p>
                    </div>

                    <div v-else class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>昵称</th>
                                <th>公钥地址</th>
                                <th>私钥预览</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <template v-for="key in privateKeys" :key="key.id">
                                <tr>
                                    <td>
                                        <strong v-text="key.nickname"></strong>
                                    </td>
                                    <td>
                                        <code class="small address-copy"
                                              @click="copyToClipboard(key.public_key, '公钥地址')"
                                              :title="key.public_key + ' (点击复制)'"
                                              style="cursor: pointer; user-select: none;"
                                              v-text="key.public_key.substring(0, 8) + '...' + key.public_key.substring(key.public_key.length - 8)">
                                        </code>
                                        <i class="fas fa-copy ms-1 text-muted" style="font-size: 0.8em;"></i>
                                    </td>
                                    <td>
                                        <code class="small text-muted" v-text="key.private_key_preview"></code>
                                    </td>
                                    <td>
                                        <small v-text="formatTime(key.created_at)"></small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                    class="btn btn-outline-info"
                                                    @click="toggleWalletTokens(key.id)"
                                                    :title="walletTokensExpanded[key.id] ? '收起Token明细' : '展开Token明细'">
                                                <span v-if="walletTokensLoading[key.id]"
                                                      class="spinner-border spinner-border-sm"></span>
                                                <i v-else-if="walletTokensExpanded[key.id]"
                                                   class="fas fa-chevron-up"></i>
                                                <i v-else class="fas fa-chevron-down"></i>
                                            </button>
                                            <button
                                                    class="btn btn-outline-primary"
                                                    @click="editKey(key)"
                                                    title="编辑">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button
                                                    class="btn btn-outline-danger"
                                                    @click="deleteKey(key.id)"
                                                    title="删除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Token明细展开行 -->
                                <tr v-if="walletTokensExpanded[key.id]" class="bg-light">
                                    <td colspan="5" class="p-0">
                                        <div class="p-3">
                                            <div v-if="walletTokensLoading[key.id]" class="text-center py-3">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="mt-2 text-muted">加载Token明细中...</p>
                                            </div>
                                            <div v-else-if="walletTokensData[key.id] && walletTokensData[key.id].tokens.length > 0">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-coins me-2 text-primary"></i>
                                                        <span v-text="key.nickname"></span> 的Token明细
                                                    </h6>
                                                    <div class="text-muted d-flex align-items-center gap-2">
                                                        总价值: <span class="text-success fw-bold"
                                                                      v-text="'$' + walletTokensData[key.id].total_usd.toFixed(2)"></span>
                                                        <button class="btn btn-outline-primary btn-sm ms-2"
                                                                :disabled="walletTokensLoading[key.id]"
                                                                @click="refreshWalletTokens(key.id)">
                                                            <span v-if="walletTokensLoading[key.id]"
                                                                  class="spinner-border spinner-border-sm me-1"></span>
                                                            <i v-else class="fas fa-refresh me-1"></i>
                                                            <span v-if="walletTokensLoading[key.id]">刷新中...</span>
                                                            <span v-else>刷新</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-sm mb-0">
                                                        <thead>
                                                        <tr>
                                                            <th>Token</th>
                                                            <th>符号</th>
                                                            <th>持有量</th>
                                                            <th>价格</th>
                                                            <th>价值</th>
                                                            <th>Token地址</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr v-for="token in walletTokensData[key.id].tokens"
                                                            :key="token.address">
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <img v-if="token.logo_uri" :src="token.logo_uri"
                                                                         alt="token logo" class="me-2 rounded-circle"
                                                                         style="width: 20px; height: 20px;"
                                                                         @error="$event.target.style.display='none'">
                                                                    <a :href="'https://dexscreener.com/solana/' + token.address"
                                                                       target="_blank"
                                                                       class="text-decoration-none fw-bold text-primary"
                                                                       :title="'在DexScreener上查看 ' + token.name"
                                                                       v-text="token.name"></a>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-secondary small"
                                                                      v-text="token.symbol"></span>
                                                            </td>
                                                            <td v-text="formatAmount(token.amount)"></td>
                                                            <td v-text="'$' + token.price_usd.toFixed(6)"></td>
                                                            <td>
                                                                <span class="text-success fw-bold"
                                                                      v-text="'$' + token.value_usd.toFixed(2)"></span>
                                                            </td>
                                                            <td>
                                                                <code class="small address-copy"
                                                                      @click="copyToClipboard(token.address, 'Token地址')"
                                                                      :title="token.address + ' (点击复制)'"
                                                                      style="cursor: pointer; user-select: none;"
                                                                      v-text="token.address.substring(0, 6) + '...' + token.address.substring(token.address.length - 6)">
                                                                </code>
                                                                <i class="fas fa-copy ms-1 text-muted"
                                                                   style="font-size: 0.7em;"></i>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-outline-success btn-sm"
                                                                        @click="openConvertModal(key, token)">
                                                                    <i class="fas fa-exchange-alt me-1"></i>兑换
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div v-else class="text-center py-3 text-muted">
                                                <i class="fas fa-coins fa-2x mb-2"></i>
                                                <p class="mb-0">该钱包暂无Token记录</p>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑私钥模态框 -->
    <div class="modal fade" :class="{ show: showAddModal || showEditModal }"
         :style="{ display: showAddModal || showEditModal ? 'block' : 'none' }"
         @click="closeModal">
        <div class="modal-dialog" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>
                        <span v-if="showEditModal">编辑私钥</span>
                        <span v-else>添加私钥</span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeModal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveKey">
                        <div class="mb-3">
                            <label class="form-label">私钥昵称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="keyForm.nickname" required>
                            <div class="form-text">给私钥起一个容易识别的名称</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">私钥 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <textarea class="form-control" rows="3" v-model="keyForm.private_key" required
                                          placeholder="请输入Solana钱包私钥 (Base58格式)"></textarea>
                                <button type="button" class="btn btn-outline-secondary generate-key-btn"
                                        @click="generatePrivateKey"
                                        :disabled="generateLoading || showEditModal"
                                        style="writing-mode: vertical-lr; text-orientation: mixed;"
                                        :title="showEditModal ? '编辑模式下不可生成' : '生成新私钥'">
                                    <span v-if="generateLoading" class="spinner-border spinner-border-sm"></span>
                                    <span v-else>
                                        <i class="fas fa-dice d-block mb-1"></i>
                                        <small>生成</small>
                                    </span>
                                </button>
                            </div>
                            <div class="form-text text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                私钥将被安全加密存储，请确保私钥来源安全可靠
                            </div>
                            <div class="form-text text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                点击"生成"按钮可以自动生成新的Solana私钥
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
                            <button type="submit" class="btn btn-primary" :disabled="saveLoading">
                                <span v-if="saveLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="saveLoading">保存中...</span>
                                <span v-else>保存</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 导出确认模态框 -->
    <div class="modal fade" :class="{ show: showExportModal }"
         :style="{ display: showExportModal ? 'block' : 'none' }"
         @click="closeExportModal">
        <div class="modal-dialog modal-dialog-centered" @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        导出私钥确认
                    </h5>
                    <button type="button" class="btn-close" @click="closeExportModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>安全警告</strong>
                        <p class="mb-0 mt-2">您即将导出包含完整私钥信息的敏感数据。请确保：</p>
                        <ul class="mt-2 mb-0">
                            <li>在安全的环境中操作</li>
                            <li>导出后妥善保管数据</li>
                            <li>不要在不安全的网络中传输</li>
                        </ul>
                    </div>
                    <form @submit.prevent="exportPrivateKeys">
                        <div class="mb-3">
                            <label class="form-label">请输入导出Token <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" v-model="exportToken"
                                   placeholder="请输入导出验证token" required>
                            <div class="form-text">请联系管理员获取导出token</div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeExportModal">取消</button>
                            <button type="submit" class="btn btn-danger" :disabled="exportLoading">
                                <span v-if="exportLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <i v-else class="fas fa-download me-2"></i>
                                <span v-if="exportLoading">导出中...</span>
                                <span v-else>确认导出</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框背景 -->
    <div v-if="showAddModal || showEditModal || showExportModal" class="modal-backdrop fade show"></div>

    <!-- 消息提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div v-for="message in messages" :key="message.id"
             class="toast align-items-center border-0 show mb-2"
             :class="message.type === 'success' ? 'text-bg-success' : 'text-bg-danger'"
             style="max-width: 90vw; min-width: 220px; word-break: break-all; white-space: pre-line;">
            <div class="d-flex">
                <div class="toast-body" style="max-width: 70vw; word-break: break-all; white-space: pre-line;"
                     v-text="message.text">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        @click="removeMessage(message.id)"></button>
            </div>
        </div>
    </div>

    <!-- 兑换Token模态框 -->
    <div class="modal fade" :class="{ show: showConvertModal }"
         :style="{ display: showConvertModal ? 'block' : 'none' }"
         @click="closeConvertModal">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 500px; width: 95vw;" @click.stop>
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt me-2"></i>
                        Token兑换
                    </h5>
                    <button type="button" class="btn-close" @click="closeConvertModal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="getQuote">
                        <div v-if="convertFromToken">
                            <div class="mb-3">
                                <label class="form-label">兑换自 (From)</label>
                                <div class="d-flex align-items-center">
                                    <img v-if="convertFromToken.logo_uri" :src="convertFromToken.logo_uri"
                                         style="width:24px;height:24px;" class="me-2 rounded-circle">
                                    <span class="fw-bold me-2" v-text="convertFromToken.name"></span>
                                    <span class="badge bg-secondary" v-text="convertFromToken.symbol"></span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 position-relative">
                            <label class="form-label">兑换至 (To) Token地址 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="convertToAddress" @input="onToInput"
                                   @focus="onToInput" @blur="onToBlur" required placeholder="请输入目标Token地址或选择"
                                   autocomplete="off">
                            <div v-if="showToDropdown && filteredToTokenList.length > 0"
                                 class="dropdown-menu show w-100 mt-1"
                                 style="max-height:260px;overflow:auto;z-index:1050;">
                                <div v-for="token in filteredToTokenList" :key="token.address"
                                     class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer;"
                                     @mousedown.prevent="selectToToken(token)">
                                    <img v-if="token.logo_uri" :src="token.logo_uri" style="width:20px;height:20px;"
                                         class="rounded-circle">
                                    <span class="fw-bold" v-text="token.name"></span>
                                    <span class="badge bg-secondary ms-2" v-text="token.symbol"></span>
                                    <span class="text-muted ms-auto small"
                                          v-text="token.address.substring(0,6)+'...'+token.address.substring(token.address.length-6)"></span>
                                </div>
                            </div>
                            <div v-if="convertToToken" class="form-text">
                                <img v-if="convertToToken.logo_uri" :src="convertToToken.logo_uri"
                                     style="width:20px;height:20px;" class="me-2 rounded-circle">
                                <span class="fw-bold me-2" v-text="convertToToken.name"></span>
                                <span class="badge bg-secondary" v-text="convertToToken.symbol"></span>
                            </div>
                            <div v-if="convertToTokenError" class="text-danger small mt-1">
                                <i class="fas fa-exclamation-triangle me-1"></i>{{ convertToTokenError }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-flex align-items-center justify-content-between">
                                <div>
                                    <span v-if="!isAmountInUsd">兑换数量</span>
                                    <span v-else>兑换金额</span>
                                    <span class="text-danger">*</span>
                                </div>
                                {% raw %}
                                <div>
                                    <button v-for="p in [0.25,0.5,0.75,1]" :key="p" type="button"
                                            class="btn btn-sm btn-outline-primary ms-1"
                                            @click="isAmountInUsd ? setQuickAmountUsd(p) : setQuickAmount(p)">{{ (p
                                        *100).toFixed(0) }}%
                                    </button>
                                </div>
                                {% endraw %}
                            </label>
                            <div class="input-group">
                                <input v-if="!isAmountInUsd" type="number" class="form-control"
                                       v-model.number="convertAmount"
                                       :max="convertFromToken ? convertFromToken.amount : null" min="0" step="any"
                                       required
                                       placeholder="请输入要兑换的数量">
                                <input v-else type="number" class="form-control" v-model.number="convertAmountUsd"
                                       min="0" step="any" required placeholder="请输入要兑换的USD金额">
                                {% raw %}
                                <span class="input-group-text"
                                      v-if="!isAmountInUsd && convertFromToken">{{ convertFromToken.symbol }}</span>
                                <span class="input-group-text" v-else>$</span>
                                {% endraw %}
                                <button class="btn btn-outline-secondary" type="button" @click="toggleAmountInputMode"
                                        :title="isAmountInUsd ? '切换为按Token数量输入' : '切换为按USD金额输入'">
                                    <i v-if="isAmountInUsd" class="fas fa-hashtag"></i>
                                    <i v-else class="fas fa-dollar-sign"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <template v-if="!isAmountInUsd">
                                    可用余额: <span
                                            v-text="convertFromToken ? formatAmount(convertFromToken.amount) : '--'"></span>
                                </template>
                                <template v-else>
                                    当前Token价格: <span
                                            v-text="convertFromToken ? ('$' + convertFromToken.price_usd.toFixed(6)) : '--'"></span>
                                    {% raw %}
                                    <br>
                                    <span class="text-danger" v-if="convertAmountUsd > maxConvertUsd">输入金额超出最大可兑换USD ({{ maxConvertUsd.toFixed(2) }})</span>
                                    <span class="text-muted" v-else>最大可兑换: ${{ maxConvertUsd.toFixed(2) }}</span>
                                    {% endraw %}
                                </template>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @click="closeConvertModal">取消</button>
                            <button type="submit" class="btn btn-primary"
                                    :disabled="quoteLoading || (isAmountInUsd && convertAmountUsd > maxConvertUsd)">
                                <span v-if="quoteLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="quoteLoading">获取报价中...</span>
                                <span v-else>获取报价</span>
                            </button>
                        </div>
                    </form>
                    <div v-if="convertQuote" class="alert alert-info mt-3">
                        <div>
                            <strong>兑换结果：</strong>
                            <div>可获得 <span class="fw-bold" v-text="convertQuote.outAmountDisplay"></span> <span
                                        v-text="convertToToken ? convertToToken.symbol : ''"></span></div>
                            <div>预估价值：<span class="fw-bold text-success"
                                                v-text="'$ ' + convertQuote.estimatedUsd"></span></div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-success" @click="doSwap" :disabled="swapLoading">
                                <span v-if="swapLoading" class="spinner-border spinner-border-sm me-2"></span>
                                <span v-if="swapLoading">交易中...</span>
                                <span v-else>确认兑换</span>
                            </button>
                        </div>
                    </div>
                    <div v-if="swapResult" class="alert mt-3"
                         :class="swapResult.success ? 'alert-success' : 'alert-danger'">
                        <template v-if="typeof swapResult.txid === 'string'">
                            <i class="fas fa-check-circle me-1"></i>兑换成功！
                            <div>
                                交易哈希：
                                <a :href="'https://solscan.io/tx/' + swapResult.txid" target="_blank"
                                   :title="swapResult.txid"
                                   style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:bottom;">
                                    <span v-text="swapResult.txid.substring(0, 8) + '...' + swapResult.txid.substring(swapResult.txid.length-8)"></span>
                                </a>
                            </div>
                        </template>
                        <template v-else-if="swapResult.message">
                            <i class="fas fa-times-circle me-1 text-danger"></i>
                            <span class="text-danger">链上交易失败：</span>
                            <pre class="text-danger small" style="white-space: pre-wrap;" v-text="swapResult.message"></pre>
                            <div v-if="swapResult.program_logs && swapResult.program_logs.length" class="mt-2">
                                <span class="fw-bold">链上日志：</span>
                                <pre class="small bg-light border p-2" style="white-space: pre-wrap;max-height:200px;overflow:auto;" v-text="swapResult.program_logs.join('\n')"></pre>
                            </div>
                        </template>
                        <template v-else>
                            <span class="text-danger">未知结果</span>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const {createApp} = Vue;

    createApp({
        data() {
            return {
                privateKeys: [],
                loading: true,
                saveLoading: false,
                generateLoading: false,
                exportLoading: false,
                summaryLoading: false,
                showAddModal: false,
                showEditModal: false,
                showExportModal: false,
                editingKeyId: null,
                keyForm: {
                    nickname: '',
                    private_key: ''
                },
                exportToken: '',
                messages: [],
                tokenSummary: {
                    total_wallets: 0,
                    total_sol: 0,
                    total_usd: 0,
                    tokens: []
                },
                walletTokensExpanded: {}, // 钱包Token明细展开状态
                walletTokensLoading: {}, // 钱包Token明细加载状态
                walletTokensData: {}, // 钱包Token明细数据
                isUsingCache: false, // 是否正在使用缓存数据
                showConvertModal: false,
                convertFromKey: null,
                convertFromToken: null,
                convertToAddress: '',
                convertToToken: null,
                convertToTokenError: '',
                convertAmount: '',
                quoteLoading: false,
                convertQuote: null,
                swapLoading: false,
                swapResult: null,
                commonTokens: [
                    {
                        address: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',
                        name: 'Tether USD',
                        symbol: 'USDT',
                        logo_uri: 'https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB/logo.svg'
                    },
                    {
                        address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
                        name: 'USD Coin',
                        symbol: 'USDC',
                        logo_uri: 'https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/logo.png'
                    }
                ],
                showToDropdown: false,
                filteredToTokenList: [],
                isAmountInUsd: false,
                convertAmountUsd: '',
                maxConvertUsd: 0,
            }
        },
        mounted() {
            this.loadPrivateKeys();
            this.loadTokenSummary();
            // 重置缓存状态
            this.isUsingCache = false;
        },
        methods: {
            async loadPrivateKeys() {
                try {
                    const response = await fetch('/api/keys');
                    const data = await response.json();
                    if (data.success) {
                        this.privateKeys = data.data;
                    } else {
                        this.showMessage('error', data.error || '加载私钥失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.loading = false;
                }
            },
            async loadTokenSummary() {
                // 检查本地缓存
                const cacheKey = 'token_summary_cache';
                const cacheData = localStorage.getItem(cacheKey);

                if (cacheData) {
                    try {
                        const cached = JSON.parse(cacheData);
                        const now = Date.now();
                        const cacheAge = now - cached.timestamp;
                        const cacheExpiry = 30 * 60 * 1000; // 30分钟

                        if (cacheAge < cacheExpiry) {
                            // 缓存有效，直接使用
                            this.tokenSummary = cached.data;
                            this.isUsingCache = true;
                            return;
                        }
                    } catch (e) {
                        // 缓存数据损坏，清除它
                        localStorage.removeItem(cacheKey);
                    }
                }

                // 缓存无效或不存在，从服务器获取
                this.summaryLoading = true;
                try {
                    const response = await fetch('/api/keys/summary/tokens');
                    const data = await response.json();
                    if (data.success) {
                        this.tokenSummary = data.data;
                        this.isUsingCache = false;

                        // 保存到本地缓存
                        const cacheData = {
                            data: data.data,
                            timestamp: Date.now()
                        };
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                    } else {
                        this.showMessage('error', data.error || '加载Token汇总失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.summaryLoading = false;
                }
            },
            async refreshTokenSummary() {
                // 清除本地缓存
                localStorage.removeItem('token_summary_cache');
                this.isUsingCache = false;
                await this.loadTokenSummary();
                this.showMessage('success', 'Token汇总数据已刷新');
            },
            async saveKey() {
                this.saveLoading = true;
                try {
                    const formData = new FormData();
                    Object.keys(this.keyForm).forEach(key => {
                        formData.append(key, this.keyForm[key]);
                    });

                    const url = this.showEditModal
                        ? `/api/keys/${this.editingKeyId}`
                        : '/api/keys';

                    const method = this.showEditModal ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.showMessage('success', data.message);
                        this.closeModal();
                        // 清理所有展开状态，因为钱包列表可能会改变
                        this.walletTokensExpanded = {};
                        this.walletTokensLoading = {};
                        this.walletTokensData = {};
                        // 清除缓存，因为私钥发生了变化
                        localStorage.removeItem('token_summary_cache');
                        this.isUsingCache = false;
                        this.loadPrivateKeys();
                        this.loadTokenSummary();
                    } else {
                        this.showMessage('error', data.error || '保存失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.saveLoading = false;
                }
            },
            async deleteKey(keyId) {
                if (!confirm('确定要删除这个私钥吗？删除后数据将被标记为删除状态（逻辑删除），相关的监控记录将无法使用。')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/keys/${keyId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.showMessage('success', data.message);
                        // 清理钱包Token相关状态
                        const newExpanded = {...this.walletTokensExpanded};
                        const newLoading = {...this.walletTokensLoading};
                        const newData = {...this.walletTokensData};
                        delete newExpanded[keyId];
                        delete newLoading[keyId];
                        delete newData[keyId];
                        this.walletTokensExpanded = newExpanded;
                        this.walletTokensLoading = newLoading;
                        this.walletTokensData = newData;
                        // 清除缓存，因为私钥发生了变化
                        localStorage.removeItem('token_summary_cache');
                        this.isUsingCache = false;
                        this.loadPrivateKeys();
                        this.loadTokenSummary();
                    } else {
                        this.showMessage('error', data.error || '删除失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                }
            },
            editKey(key) {
                this.editingKeyId = key.id;
                this.keyForm = {
                    nickname: key.nickname,
                    private_key: ''  // 安全起见，不回填私钥
                };
                this.showEditModal = true;
            },
            closeModal() {
                this.showAddModal = false;
                this.showEditModal = false;
                this.editingKeyId = null;
                this.keyForm = {
                    nickname: '',
                    private_key: ''
                };
            },
            formatTime(timestamp) {
                if (!timestamp) return '--';
                return new Date(timestamp).toLocaleString('zh-CN');
            },
            showMessage(type, text) {
                const id = Date.now() + Math.random();
                this.messages.push({id, type, text});
                setTimeout(() => {
                    this.removeMessage(id);
                }, 5000);
            },
            removeMessage(id) {
                this.messages = this.messages.filter(m => m.id !== id);
            },
            copyToClipboard(text, type) {
                // 优先使用现代 Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showMessage('success', `${type}已复制到剪贴板`);
                    }).catch(err => {
                        console.error('Clipboard API 失败:', err);
                        this.fallbackCopyTextToClipboard(text, type);
                    });
                } else {
                    // 使用备用方案
                    this.fallbackCopyTextToClipboard(text, type);
                }
            },
            fallbackCopyTextToClipboard(text, type) {
                // 创建临时文本区域
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);

                try {
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showMessage('success', `${type}已复制到剪贴板`);
                    } else {
                        this.showMessage('error', '复制失败，请手动复制');
                    }
                } catch (err) {
                    console.error('备用复制方法失败:', err);
                    this.showMessage('error', '复制失败，请手动复制');
                } finally {
                    document.body.removeChild(textArea);
                }
            },
            async generatePrivateKey() {
                this.generateLoading = true;
                try {
                    const response = await fetch('/api/keys/generate', {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success) {
                        this.keyForm.private_key = data.data.private_key;
                        this.showMessage('success', '私钥生成成功！公钥地址：' + data.data.public_key.substring(0, 8) + '...' + data.data.public_key.substring(data.data.public_key.length - 8));
                    } else {
                        this.showMessage('error', data.error || '生成私钥失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.generateLoading = false;
                }
            },
            closeExportModal() {
                this.showExportModal = false;
                this.exportToken = '';
            },
            async exportPrivateKeys() {
                this.exportLoading = true;
                try {
                    const formData = new FormData();
                    formData.append('token', this.exportToken);

                    const response = await fetch('/api/keys/export', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        // 创建下载文件
                        const jsonData = JSON.stringify(data.data, null, 2);
                        const blob = new Blob([jsonData], {type: 'application/json'});
                        const url = URL.createObjectURL(blob);

                        // 创建临时下载链接
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `private_keys_export_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        this.showMessage('success', `导出成功！共导出 ${data.data.total_count} 个私钥`);
                        this.closeExportModal();
                    } else {
                        this.showMessage('error', data.error || '导出失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.exportLoading = false;
                }
            },
            formatAmount(amount) {
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(2) + 'M';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(2) + 'K';
                } else if (amount >= 1) {
                    return amount.toFixed(2);
                } else {
                    return amount.toFixed(6);
                }
            },
            async toggleWalletTokens(keyId) {
                // 如果已经展开，则收起
                if (this.walletTokensExpanded[keyId]) {
                    this.walletTokensExpanded = {...this.walletTokensExpanded, [keyId]: false};
                    return;
                }

                // 展开并加载数据
                this.walletTokensExpanded = {...this.walletTokensExpanded, [keyId]: true};

                // 如果已经有数据，直接返回
                if (this.walletTokensData[keyId]) {
                    return;
                }

                // 加载数据
                await this.loadWalletTokens(keyId);
            },
            async loadWalletTokens(keyId) {
                this.walletTokensLoading = {...this.walletTokensLoading, [keyId]: true};
                try {
                    const response = await fetch(`/api/keys/${keyId}/tokens`);
                    const data = await response.json();
                    if (data.success) {
                        this.walletTokensData = {...this.walletTokensData, [keyId]: data.data};
                    } else {
                        this.showMessage('error', data.error || '加载Token明细失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.walletTokensLoading = {...this.walletTokensLoading, [keyId]: false};
                }
            },
            async refreshWalletTokens(keyId) {
                // 刷新单个钱包Token明细
                this.walletTokensLoading = {...this.walletTokensLoading, [keyId]: true};
                try {
                    const response = await fetch(`/api/keys/${keyId}/tokens`);
                    const data = await response.json();
                    if (data.success) {
                        this.walletTokensData = {...this.walletTokensData, [keyId]: data.data};
                        this.showMessage('success', 'Token明细已刷新');
                    } else {
                        this.showMessage('error', data.error || '刷新Token明细失败');
                    }
                } catch (error) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.walletTokensLoading = {...this.walletTokensLoading, [keyId]: false};
                }
            },
            openConvertModal(key, token) {
                this.convertFromKey = key;
                this.convertFromToken = token;
                this.showConvertModal = true;
                this.convertToAddress = '';
                this.convertToToken = null;
                this.convertToTokenError = '';
                this.convertAmount = '';
                this.convertAmountUsd = '';
                this.convertQuote = null;
                this.swapResult = null;
                this.isAmountInUsd = false;
                // 计算最大可兑换USD
                this.maxConvertUsd = token && token.price_usd ? (token.amount * token.price_usd) : 0;
            },
            closeConvertModal() {
                this.showConvertModal = false;
                this.convertFromKey = null;
                this.convertFromToken = null;
                this.convertToAddress = '';
                this.convertToToken = null;
                this.convertToTokenError = '';
                this.convertAmount = '';
                this.convertAmountUsd = ''; // 重置USD输入框
                this.convertQuote = null;
                this.swapResult = null;
                this.isAmountInUsd = false; // 关闭时重置模式
            },
            async fetchToTokenInfo() {
                this.convertToToken = null;
                this.convertToTokenError = '';
                if (!this.convertToAddress) return;
                try {
                    // 假设有/api/token_info?address=xxx
                    const resp = await fetch(`/api/token_info?address=${this.convertToAddress}`);
                    const data = await resp.json();
                    if (data.success) {
                        this.convertToToken = data.data;
                    } else {
                        this.convertToTokenError = data.error || '未找到Token信息';
                    }
                } catch (e) {
                    this.convertToTokenError = '查询失败';
                }
            },
            async getQuote() {
                if (this.isAmountInUsd && this.convertAmountUsd > this.maxConvertUsd) {
                    this.showMessage('error', `输入金额不能超过最大可兑换USD ($${this.maxConvertUsd.toFixed(2)})`);
                    return;
                }
                this.quoteLoading = true;
                this.convertQuote = null;
                this.swapResult = null;
                try {
                    const params = new URLSearchParams({
                        from: this.convertFromToken.address,
                        to: this.convertToAddress,
                        key_id: this.convertFromKey.id
                    });
                    if (this.isAmountInUsd) {
                        params.append('amount_in_usd', this.convertAmountUsd);
                    } else {
                        params.append('amount', this.convertAmount);
                    }
                    const resp = await fetch(`/api/quote?${params.toString()}`);
                    const data = await resp.json();
                    if (data.success) {
                        this.convertQuote = data.data;
                    } else {
                        this.showMessage('error', data.error || '获取报价失败');
                    }
                } catch (e) {
                    this.showMessage('error', '网络错误');
                } finally {
                    this.quoteLoading = false;
                }
            },
            async doSwap() {
                this.swapLoading = true;
                this.swapResult = null;
                try {
                    // 假设有/api/swap POST
                    const resp = await fetch('/api/swap', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            from: this.convertFromToken.address,
                            to: this.convertToAddress,
                            amount: this.convertAmount,
                            key_id: this.convertFromKey.id,
                            quote: this.convertQuote
                        })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        this.swapResult = {success: true, txid: data.data.txid};
                    } else {
                        this.swapResult = {
                            success: false,
                            message: data.error || '兑换失败',
                            program_logs: data.program_logs || null
                        };
                    }
                } catch (e) {
                    this.swapResult = {success: false, message: '网络错误'};
                } finally {
                    this.swapLoading = false;
                }
            },
            onToInput() {
                const q = this.convertToAddress.trim().toLowerCase();
                let all = [...this.commonTokens, ...this.tokenSummary.tokens];
                if (q) {
                    this.filteredToTokenList = all.filter(t =>
                        t.address.toLowerCase().includes(q) ||
                        (t.name && t.name.toLowerCase().includes(q)) ||
                        (t.symbol && t.symbol.toLowerCase().includes(q))
                    );
                } else {
                    this.filteredToTokenList = all;
                }
                this.showToDropdown = this.filteredToTokenList.length > 0;
            },
            selectToToken(token) {
                this.convertToAddress = token.address;
                this.showToDropdown = false;
                this.fetchToTokenInfo();
            },
            onToBlur() {
                setTimeout(() => {
                    this.showToDropdown = false;
                    this.fetchToTokenInfo();
                    console.log('onToBlur, hide dropdown and fetch token info');
                }, 200);
            },
            toggleAmountInputMode() {
                this.isAmountInUsd = !this.isAmountInUsd;
                if (this.isAmountInUsd) {
                    // 切到USD，自动填充USD金额
                    if (this.convertAmount && this.convertFromToken && this.convertFromToken.price_usd) {
                        this.convertAmountUsd = (this.convertAmount * this.convertFromToken.price_usd).toFixed(2);
                    } else {
                        this.convertAmountUsd = '';
                    }
                } else {
                    // 切到Token数量，自动换算
                    if (this.convertAmountUsd && this.convertFromToken && this.convertFromToken.price_usd) {
                        this.convertAmount = (this.convertAmountUsd / this.convertFromToken.price_usd).toFixed(6);
                    } else {
                        this.convertAmount = '';
                    }
                }
            },
            setQuickAmount(percent) {
                if (this.convertFromToken) {
                    this.convertAmount = (this.convertFromToken.amount * percent).toFixed(6);
                    if (this.isAmountInUsd && this.convertFromToken.price_usd) {
                        this.convertAmountUsd = (this.convertAmount * this.convertFromToken.price_usd).toFixed(2);
                    }
                }
            },
            setQuickAmountUsd(percent) {
                if (this.convertFromToken && this.convertFromToken.price_usd) {
                    this.convertAmountUsd = (this.maxConvertUsd * percent).toFixed(2);
                    if (!this.isAmountInUsd) {
                        this.convertAmount = (this.convertAmountUsd / this.convertFromToken.price_usd).toFixed(6);
                    }
                }
            }
        }
    }).mount('#app');
</script>
{% endblock %}
